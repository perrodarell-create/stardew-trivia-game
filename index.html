<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardew Valley Trivia - 5 Niveles Tem√°ticos</title>
    <style>
        /* RESET Y BASE CON PIXEL ART */
        * { margin: 0; padding: 0; box-sizing: border-box; image-rendering: pixelated; }
        
        body { 
            background: #1a1f2b;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            padding: 15px;
            color: #333;
            image-rendering: pixelated;
        }
        
        .game-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            background: #2c3e50;
            border-radius: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            overflow: hidden;
            border: 8px solid #1a252f;
            image-rendering: pixelated;
        }
        
        /* HEADER CON NIVELES - PIXEL ART */
        .game-header {
            background: #1a252f;
            padding: 15px;
            color: white;
            position: relative;
            border-bottom: 4px solid #34495e;
        }
        
        .game-title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
            color: #f1c40f;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
        }
        
        .levels-nav {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .level-btn {
            padding: 8px 16px;
            background: #34495e;
            border: 3px solid #2c3e50;
            border-radius: 0;
            color: #ecf0f1;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Courier New', monospace;
            image-rendering: pixelated;
        }
        
        .level-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            background: #4a6572;
            border-color: #f1c40f;
        }
        
        .level-btn.active {
            background: #f1c40f;
            color: #2c3e50;
            border-color: #f39c12;
            box-shadow: 0 4px 0 #d35400;
        }
        
        .level-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* BARRA DE ESTAD√çSTICAS - PIXEL ART */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 12px;
            background: #34495e;
            border-bottom: 4px solid #2c3e50;
        }
        
        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .stat-card {
            background: #2c3e50;
            padding: 10px;
            border-radius: 0;
            text-align: center;
            box-shadow: inset 0 0 0 2px #1a252f;
            border: 3px solid;
            image-rendering: pixelated;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #bdc3c7;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
        }
        
        .stat-value {
            font-size: 1.6rem;
            font-weight: bold;
            color: #ecf0f1;
            text-shadow: 2px 2px 0 #000;
        }
        
        .hearts-display {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin-top: 5px;
        }
        
        .heart {
            font-size: 1.5rem;
        }
        
        /* √ÅREA DE JUEGO PRINCIPAL CON TEMAS */
        .game-main {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 15px;
            padding: 15px;
            min-height: 550px;
            background: #1a252f;
        }
        
        @media (max-width: 900px) {
            .game-main {
                grid-template-columns: 1fr;
            }
        }
        
        /* TEMAS PARA CADA NIVEL */
        .theme-agricultura {
            background: linear-gradient(to bottom, #27ae60, #2ecc71);
            border-color: #27ae60;
        }
        
        .theme-pesca {
            background: linear-gradient(to bottom, #2980b9, #3498db);
            border-color: #2980b9;
        }
        
        .theme-ganaderia {
            background: linear-gradient(to bottom, #e67e22, #f39c12);
            border-color: #e67e22;
        }
        
        .theme-mineria {
            background: linear-gradient(to bottom, #7f8c8d, #95a5a6);
            border-color: #7f8c8d;
        }
        
        .theme-tecnologia {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            border-color: #8e44ad;
            position: relative;
            overflow: hidden;
        }
        
        /* EFECTO DE INVERNADERO PARA TECNOLOG√çA */
        .greenhouse-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, transparent 49%, rgba(46, 204, 113, 0.1) 50%, transparent 51%),
                linear-gradient(transparent 49%, rgba(46, 204, 113, 0.1) 50%, transparent 51%);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 1;
        }
        
        .greenhouse-plants {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60px;
            background: 
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><rect x="10" y="5" width="5" height="15" fill="%2327ae60"/><rect x="15" y="0" width="10" height="10" fill="%232ecc71"/><rect x="30" y="8" width="5" height="12" fill="%2327ae60"/><rect x="35" y="3" width="8" height="8" fill="%232ecc71"/><rect x="55" y="3" width="5" height="17" fill="%2327ae60"/><rect x="60" y="0" width="12" height="12" fill="%232ecc71"/><rect x="80" y="7" width="5" height="13" fill="%2327ae60"/><rect x="85" y="2" width="9" height="9" fill="%232ecc71"/></svg>')
                repeat-x;
            z-index: 2;
        }
        
        /* PANEL DE JUEGO */
        .game-panel {
            background: rgba(44, 62, 80, 0.9);
            border-radius: 0;
            padding: 15px;
            border: 4px solid;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 3;
        }
        
        /* PANEL DE PREGUNTAS */
        .questions-panel {
            border-color: #27ae60;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid rgba(0,0,0,0.3);
        }
        
        .level-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .level-icon {
            font-size: 2.5rem;
            filter: drop-shadow(2px 2px 0 #000);
        }
        
        .level-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ecf0f1;
            text-shadow: 2px 2px 0 #000;
        }
        
        .timer-box {
            background: #2c3e50;
            color: white;
            padding: 6px 15px;
            border-radius: 0;
            font-size: 1.2rem;
            font-weight: bold;
            border: 3px solid #34495e;
            box-shadow: inset 0 0 0 2px #1a252f;
        }
        
        .timer-box.warning {
            background: #f39c12;
            border-color: #e67e22;
            animation: pulse 1s infinite;
        }
        
        .timer-box.danger {
            background: #e74c3c;
            border-color: #c0392b;
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* PREGUNTA */
        .question-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .question-box {
            background: rgba(52, 73, 94, 0.9);
            padding: 20px;
            border-radius: 0;
            margin-bottom: 15px;
            box-shadow: inset 0 0 0 3px #1a252f;
            border-left: 6px solid #27ae60;
            flex-grow: 1;
            position: relative;
        }
        
        .question-text {
            font-size: 1.4rem;
            line-height: 1.6;
            color: #ecf0f1;
            margin-bottom: 20px;
            text-shadow: 1px 1px 0 #000;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .option-btn {
            padding: 12px;
            background: #34495e;
            border: 3px solid #2c3e50;
            border-radius: 0;
            text-align: left;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #ecf0f1;
            font-family: 'Courier New', monospace;
        }
        
        .option-btn:hover {
            background: #4a6572;
            transform: translateY(-2px);
            border-color: #f1c40f;
        }
        
        .option-btn.selected {
            background: #27ae60;
            color: white;
            border-color: #2ecc71;
            box-shadow: 0 4px 0 #219653;
        }
        
        .option-btn.correct {
            background: #2ecc71;
            color: white;
            border-color: #27ae60;
        }
        
        .option-btn.incorrect {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
        }
        
        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* PANEL DE INVENTARIO/MINIJUEGO */
        .inventory-panel {
            border-color: #f39c12;
            max-height: 550px;
            overflow-y: auto;
        }
        
        .inventory-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 3px solid #f39c12;
            text-shadow: 2px 2px 0 #000;
        }
        
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .tool-item {
            background: #2c3e50;
            padding: 12px;
            border-radius: 0;
            text-align: center;
            border: 3px solid #34495e;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: inset 0 0 0 2px #1a252f;
        }
        
        .tool-item:hover {
            transform: translateY(-3px);
            border-color: #f1c40f;
        }
        
        .tool-item.active {
            background: #f39c12;
            border-color: #f1c40f;
            box-shadow: 0 4px 0 #e67e22;
        }
        
        .tool-icon {
            font-size: 2rem;
            margin-bottom: 5px;
            display: block;
            filter: drop-shadow(2px 2px 0 #000);
        }
        
        .tool-name {
            font-weight: bold;
            color: #ecf0f1;
            font-size: 0.9rem;
        }
        
        /* MINIJUEGOS */
        .minigame-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .minigame-canvas {
            background: #1a252f;
            border: 4px solid #34495e;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: block;
            margin: 10px auto;
            image-rendering: pixelated;
        }
        
        .minigame-title {
            font-size: 1.5rem;
            color: #f1c40f;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0 #000;
        }
        
        .minigame-controls {
            color: #ecf0f1;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(52, 73, 94, 0.7);
            border: 2px solid #2c3e50;
        }
        
        .minigame-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            background: rgba(44, 62, 80, 0.7);
            border: 2px solid #34495e;
        }
        
        .minigame-stat {
            text-align: center;
            color: #ecf0f1;
        }
        
        .minigame-stat-label {
            font-size: 0.8rem;
            color: #bdc3c7;
        }
        
        .minigame-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #f1c40f;
        }
        
        /* BOTONES DE MINIJUEGO */
        .minigame-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }
        
        /* BOTONES DE ACCI√ìN - PIXEL ART */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (max-width: 500px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 0;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
        }
        
        .btn-primary {
            background: linear-gradient(to bottom, #27ae60, #2ecc71);
            color: white;
            border: 3px solid #219653;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #219653;
        }
        
        .btn-secondary {
            background: linear-gradient(to bottom, #e67e22, #f39c12);
            color: white;
            border: 3px solid #d35400;
        }
        
        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #d35400;
        }
        
        .btn-minigame {
            background: linear-gradient(to bottom, #9b59b6, #8e44ad);
            color: white;
            border: 3px solid #8e44ad;
            padding: 10px 20px;
            font-size: 1rem;
        }
        
        .btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.7;
            border-color: #95a5a6;
        }
        
        /* PERSONAJES PNG - AYUDA EN TRIVIA */
        .character-help {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 150px;
            z-index: 1000;
            transition: all 0.5s;
            image-rendering: pixelated;
        }
        
        .character-img {
            width: 100%;
            height: 100%;
            filter: drop-shadow(3px 3px 0 #000);
        }
        
        .character-speech {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            border: 3px solid #34495e;
            color: #2c3e50;
            font-weight: bold;
            min-width: 150px;
            text-align: center;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .character-speech:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-top-color: white;
        }
        
        /* MENSAJES */
        .message-toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #27ae60;
            color: white;
            padding: 12px 20px;
            border-radius: 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 350px;
            border: 3px solid #219653;
            font-family: 'Courier New', monospace;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* BARRA DE PROGRESO */
        .progress-bar {
            height: 10px;
            background: #34495e;
            border-radius: 0;
            overflow: hidden;
            margin: 10px 0;
            border: 2px solid #2c3e50;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }
        
        /* TIENDA - PIXEL ART */
        .shop-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 37, 47, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .shop-modal {
            background: #2c3e50;
            width: 90%;
            max-width: 700px;
            border-radius: 0;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
            border: 8px solid #34495e;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
        }
        
        .shop-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .shop-title {
            font-size: 2.2rem;
            color: #f1c40f;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0 #000;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .shop-item {
            background: #34495e;
            padding: 15px;
            border-radius: 0;
            text-align: center;
            border: 3px solid #2c3e50;
            transition: all 0.3s;
            box-shadow: inset 0 0 0 2px #1a252f;
        }
        
        .shop-item:hover {
            transform: translateY(-5px);
            border-color: #f1c40f;
        }
        
        .item-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            filter: drop-shadow(2px 2px 0 #000);
        }
        
        .item-price {
            font-size: 1.3rem;
            color: #f1c40f;
            font-weight: bold;
            margin: 8px 0;
            text-shadow: 1px 1px 0 #000;
        }
        
        /* INDICADOR DE TIEMPO PAUSADO */
        .time-paused {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 0;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 1500;
            animation: pulse 1.5s infinite;
            border: 5px solid #c0392b;
            text-shadow: 2px 2px 0 #000;
        }
        
        /* FONDO PIXEL ART PARA CADA NIVEL */
        .pixel-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: 40px 40px;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }
        
        .bg-agricultura {
            background-image: 
                linear-gradient(45deg, #27ae60 25%, transparent 25%),
                linear-gradient(-45deg, #27ae60 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #27ae60 75%),
                linear-gradient(-45deg, transparent 75%, #27ae60 75%);
        }
        
        .bg-pesca {
            background-image: 
                radial-gradient(circle at 10px 10px, #2980b9 2px, transparent 3px);
            background-size: 30px 30px;
        }
        
        .bg-ganaderia {
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 19px, #e67e22 20px),
                repeating-linear-gradient(90deg, transparent, transparent 19px, #e67e22 20px);
        }
        
        .bg-mineria {
            background-image: 
                linear-gradient(45deg, #7f8c8d 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #7f8c8d 75%),
                linear-gradient(45deg, transparent 75%, #7f8c8d 75%),
                linear-gradient(45deg, #7f8c8d 25%, #95a5a6 25%);
            background-size: 40px 40px;
            background-position: 0 0, 0 20px, 20px -20px, -20px 0px;
        }
        
        .bg-tecnologia {
            background-image: 
                linear-gradient(90deg, #8e44ad 50%, transparent 50%),
                linear-gradient(0deg, #8e44ad 50%, transparent 50%);
            background-size: 30px 30px;
        }
        
        /* MENSAJE DE NIVEL BLOQUEADO */
        .locked-level {
            position: relative;
        }
        
        .locked-level:after {
            content: 'üîí';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <!-- HEADER CON SELECTOR DE NIVELES -->
        <header class="game-header">
            <h1 class="game-title">üåæ STARDEW VALLEY TRIVIA üåæ</h1>
            <nav class="levels-nav">
                <button class="level-btn active" onclick="loadLevel(0)" id="level-btn-0">
                    <span>üå±</span> Agricultura
                </button>
                <button class="level-btn" onclick="loadLevel(1)" id="level-btn-1" disabled>
                    <span>üé£</span> Pesca
                </button>
                <button class="level-btn" onclick="loadLevel(2)" id="level-btn-2" disabled>
                    <span>üêî</span> Ganader√≠a
                </button>
                <button class="level-btn" onclick="loadLevel(3)" id="level-btn-3" disabled>
                    <span>‚õèÔ∏è</span> Miner√≠a
                </button>
                <button class="level-btn" onclick="loadLevel(4)" id="level-btn-4" disabled>
                    <span>üî¨</span> Tecnolog√≠a
                </button>
            </nav>
        </header>

        <!-- BARRA DE ESTAD√çSTICAS -->
        <div class="stats-bar">
            <div class="stat-card" style="border-left-color: #27ae60;">
                <div class="stat-label">PUNTOS</div>
                <div class="stat-value" id="total-points">0</div>
            </div>
            <div class="stat-card" style="border-left-color: #2980b9;">
                <div class="stat-label">NIVEL</div>
                <div class="stat-value" id="current-level">1</div>
            </div>
            <div class="stat-card" style="border-left-color: #e67e22;">
                <div class="stat-label">PREGUNTA</div>
                <div class="stat-value" id="current-question">1/20</div>
            </div>
            <div class="stat-card" style="border-left-color: #8e44ad;">
                <div class="stat-label">TIEMPO</div>
                <div class="stat-value" id="time-left">30s</div>
            </div>
            <div class="stat-card" style="border-left-color: #7f8c8d;">
                <div class="stat-label">CORAZONES</div>
                <div class="hearts-display" id="hearts-display">
                    ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è
                </div>
            </div>
        </div>

        <!-- √ÅREA DE JUEGO PRINCIPAL -->
        <main class="game-main">
            <!-- PANEL DE PREGUNTAS CON TEMA -->
            <section class="game-panel questions-panel theme-agricultura" id="questions-panel">
                <div class="pixel-background bg-agricultura"></div>
                <div class="panel-header">
                    <div class="level-info">
                        <div class="level-icon" id="level-icon">üå±</div>
                        <div>
                            <div class="level-title" id="level-title">AGRICULTURA</div>
                            <div id="level-progress" style="color:#ecf0f1;">Pregunta 1 de 20</div>
                        </div>
                    </div>
                    <div class="timer-box" id="timer-box">
                        ‚è±Ô∏è <span id="timer">30</span>s
                    </div>
                </div>

                <div class="question-container">
                    <div class="question-box">
                        <div class="question-text" id="question-text">
                            Cargando pregunta...
                        </div>
                        <div class="options-grid" id="options-container">
                            <!-- Las opciones se cargan aqu√≠ -->
                        </div>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="openShop()">
                            üõí Tienda
                        </button>
                        <button class="btn btn-primary" id="submit-btn" onclick="submitAnswer()" disabled>
                            ‚úÖ Confirmar Respuesta
                        </button>
                    </div>
                </div>
            </section>

            <!-- PANEL DE INVENTARIO Y MINIJUEGO -->
            <section class="game-panel inventory-panel">
                <div class="inventory-title">üéí INVENTARIO DEL NIVEL</div>
                
                <!-- INVENTARIO POR NIVEL -->
                <div id="inventory-content">
                    <div class="tools-grid">
                        <!-- Se carga din√°micamente seg√∫n el nivel -->
                    </div>
                </div>

                <!-- CONTENEDOR DE MINIJUEGOS -->
                <div class="minigame-container" id="minigame-container">
                    <div class="minigame-title" id="minigame-title">üéÆ MINIJUEGO DEL NIVEL</div>
                    <canvas class="minigame-canvas" id="minigame-canvas" width="400" height="300"></canvas>
                    
                    <div class="minigame-stats" id="minigame-stats">
                        <!-- Estad√≠sticas del minijuego -->
                    </div>
                    
                    <div class="minigame-controls" id="minigame-controls">
                        <!-- Controles del minijuego -->
                    </div>
                    
                    <div class="minigame-buttons">
                        <button class="btn btn-minigame" onclick="restartMinigame()" id="restart-minigame-btn">
                            üîÑ Reiniciar
                        </button>
                        <button class="btn btn-minigame" onclick="backToTrivia()" id="back-trivia-btn">
                            ‚Üê Volver a Trivia
                        </button>
                    </div>
                </div>

                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="useHint()" id="hint-btn">
                        üí° Pista (3)
                    </button>
                    <button class="btn btn-primary" id="minigame-btn" onclick="startMinigame()" disabled>
                        üéÆ Jugar Minijuego
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- PERSONAJES DE AYUDA -->
    <div class="character-help" id="character-help" style="display:none;">
        <div class="character-speech" id="character-speech">¬°Hola! Aqu√≠ tienes una pista...</div>
        <img class="character-img" id="character-img" src="" alt="Personaje ayudante">
    </div>

    <!-- MODAL DE TIENDA -->
    <div class="shop-overlay" id="shop-overlay">
        <div class="shop-modal">
            <div class="shop-header">
                <h2 class="shop-title">üè™ TIENDA DE LA GRANJA</h2>
                <p style="color: #bdc3c7; margin: 10px 0;">
                    Puntos disponibles: <strong id="shop-balance" style="color:#f1c40f;">0</strong>
                </p>
                <p style="color: #27ae60; font-weight: bold; text-shadow: 1px 1px 0 #000;">
                    ‚è∏Ô∏è EL TIEMPO EST√Å PAUSADO
                </p>
            </div>

            <div class="shop-grid" id="shop-items">
                <!-- Items de tienda cargados din√°micamente -->
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="closeShop()" style="padding: 15px 30px; font-size: 1.2rem;">
                    ‚Üê VOLVER AL JUEGO
                </button>
            </div>
        </div>
    </div>

    <!-- INDICADOR DE TIEMPO PAUSADO -->
    <div class="time-paused" id="time-paused" style="display: none;">
        ‚è∏Ô∏è TIEMPO PAUSADO
    </div>

    <script>
        // ==================== CONFIGURACI√ìN DEL JUEGO ====================
        const GAME = {
            // Niveles del juego con temas
            levels: [
                {
                    id: 0,
                    name: "Agricultura",
                    icon: "üå±",
                    color: "#27ae60",
                    theme: "agricultura",
                    questions: 20,
                    minigame: "planting",
                    tools: [
                        { name: "Azada", icon: "‚õèÔ∏è", desc: "Prepara la tierra" },
                        { name: "Regadera", icon: "üíß", desc: "Riega los cultivos" },
                        { name: "Semillas Fresa", icon: "üçì", desc: "Planta fresas" },
                        { name: "Semillas Ma√≠z", icon: "üåΩ", desc: "Planta ma√≠z" },
                        { name: "Semillas Zanah", icon: "ü•ï", desc: "Planta zanahorias" },
                        { name: "Cosechar", icon: "‚úÇÔ∏è", desc: "Recoge cultivos" }
                    ],
                    character: "farmer",
                    completed: true,
                    unlocked: true
                },
                {
                    id: 1,
                    name: "Pesca",
                    icon: "üé£",
                    color: "#2980b9",
                    theme: "pesca",
                    questions: 20,
                    minigame: "fishing",
                    tools: [
                        { name: "Ca√±a B√°sica", icon: "üé£", desc: "Pesca simple" },
                        { name: "Cebo", icon: "ü™±", desc: "Atrae peces" },
                        { name: "Red", icon: "üï∏Ô∏è", desc: "Atrapa varios" },
                        { name: "Ca√±a Iridio", icon: "üåü", desc: "Pesca mejor" },
                        { name: "Cebo Dorado", icon: "üí∞", desc: "Pez especial" },
                        { name: "Cubeta", icon: "ü™£", desc: "Guarda peces" }
                    ],
                    character: "fisherman",
                    completed: false,
                    unlocked: false
                },
                {
                    id: 2,
                    name: "Ganader√≠a",
                    icon: "üêî",
                    color: "#e67e22",
                    theme: "ganaderia",
                    questions: 20,
                    minigame: "animals",
                    tools: [
                        { name: "Alimento", icon: "üåæ", desc: "Alimenta animales" },
                        { name: "Cepillo", icon: "üßπ", desc: "Cepilla animales" },
                        { name: "Orde√±ador", icon: "ü•õ", desc: "Saca leche" },
                        { name: "Tijeras", icon: "‚úÇÔ∏è", desc: "Corta lana" },
                        { name: "Incubadora", icon: "ü•ö", desc: "Incuba huevos" },
                        { name: "Establo", icon: "üè†", desc: "Guarda animales" }
                    ],
                    character: "rancher",
                    completed: false,
                    unlocked: false
                },
                {
                    id: 3,
                    name: "Miner√≠a",
                    icon: "‚õèÔ∏è",
                    color: "#7f8c8d",
                    theme: "mineria",
                    questions: 20,
                    minigame: "mining",
                    tools: [
                        { name: "Pico", icon: "‚õèÔ∏è", desc: "Rompe rocas" },
                        { name: "L√°mpara", icon: "üí°", desc: "Ilumina cueva" },
                        { name: "Explosivos", icon: "üí£", desc: "Destruye r√°pido" },
                        { name: "Botas", icon: "üë¢", desc: "Protege pies" },
                        { name: "Casco", icon: "‚õëÔ∏è", desc: "Protege cabeza" },
                        { name: "Mochila", icon: "üéí", desc: "Lleva minerales" }
                    ],
                    character: "miner",
                    completed: false,
                    unlocked: false
                },
                {
                    id: 4,
                    name: "Tecnolog√≠a",
                    icon: "üî¨",
                    color: "#8e44ad",
                    theme: "tecnologia",
                    questions: 20,
                    minigame: "technology",
                    tools: [
                        { name: "Fertilizante", icon: "üß™", desc: "Mejora cultivos" },
                        { name: "Sprinkler", icon: "üöø", desc: "Riega solo" },
                        { name: "Mayonero", icon: "üç∂", desc: "Hace mayonesa" },
                        { name: "Quesera", icon: "üßÄ", desc: "Hace queso" },
                        { name: "Keg", icon: "üç∫", desc: "Hace jugo/vino" },
                        { name: "Invernadero", icon: "üè°", desc: "Cultiva todo a√±o" }
                    ],
                    character: "scientist",
                    completed: false,
                    unlocked: false
                }
            ],

            // Personajes PNG
            characters: {
                farmer: "https://images.unsplash.com/photo-1585320806297-9794b3e4eeae?w=150&h=150&fit=crop&crop=face&auto=format",
                fisherman: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=150&h=150&fit=crop&crop=face&auto=format",
                rancher: "https://images.unsplash.com/photo-1546975490-a79abdd54533?w=150&h=150&fit=crop&crop=face&auto=format",
                miner: "https://images.unsplash.com/photo-1593113598332-cdcc2d4c2c8b?w=150&h=150&fit=crop&crop=face&auto=format",
                scientist: "https://images.unsplash.com/photo-1580894732444-8ecded7900cd?w=150&h=150&fit=crop&crop=face&auto=format"
            },

            // PREGUNTAS - 20 POR NIVEL
            questions: {
                // AGRICULTURA - 5 preguntas por cada estaci√≥n
                0: [
                    // PRIMAVERA (5 preguntas)
                    { q: "¬øQu√© cultivo es rojo y dulce, crece en primavera?", a: ["Zanahoria", "Fresa", "Lechuga", "Papa"], correct: 1, hint: "Es una fruta roja peque√±a" },
                    { q: "¬øQu√© verdura es naranja y crece bajo tierra en primavera?", a: ["Tomate", "Zanahoria", "Pepino", "Cebolla"], correct: 1, hint: "Los conejos la adoran" },
                    { q: "¬øQu√© flor primaveral tiene p√©talos amarillos?", a: ["Rosa", "Girasol", "Tulip√°n", "Margarita"], correct: 1, hint: "Sigue al sol" },
                    { q: "¬øQu√© necesita una planta en primavera para crecer?", a: ["Agua y sol", "Nieve y fr√≠o", "Mucho calor", "Sombra"], correct: 0, hint: "Sin esto se seca" },
                    { q: "¬øQu√© fruta crece en los √°rboles en primavera?", a: ["Manzana", "Sand√≠a", "Mel√≥n", "Pl√°tano"], correct: 0, hint: "Roja o verde" },
                    
                    // VERANO (5 preguntas)
                    { q: "¬øQu√© cultivo es amarillo y crece en mazorca en verano?", a: ["Arroz", "Trigo", "Ma√≠z", "Cebada"], correct: 2, hint: "Es amarillo y tiene granos" },
                    { q: "¬øQu√© fruta es verde por fuera y roja por dentro en verano?", a: ["Manzana", "Sand√≠a", "Pera", "Uva"], correct: 1, hint: "Tiene muchas semillas negras" },
                    { q: "¬øQu√© verdura es redonda y roja en verano?", a: ["Zanahoria", "Tomate", "Pepino", "Lechuga"], correct: 1, hint: "Se usa en ensaladas" },
                    { q: "¬øQu√© necesita m√°s una planta en verano?", a: ["M√°s agua", "Menos sol", "M√°s fr√≠o", "Menos cuidado"], correct: 0, hint: "Por el calor" },
                    { q: "¬øQu√© fruto seco se cosecha en verano?", a: ["Nuez", "Casta√±a", "Bellota", "Pi√±√≥n"], correct: 0, hint: "Tiene c√°scara dura" },
                    
                    // OTO√ëO (5 preguntas)
                    { q: "¬øQu√© calabaza es naranja y se usa en oto√±o?", a: ["Calabac√≠n", "Calabaza Halloween", "Pepino", "Berenjena"], correct: 1, hint: "Para decorar" },
                    { q: "¬øQu√© fruto seco cae de los √°rboles en oto√±o?", a: ["Pl√°tano", "Manzana", "Bellota", "Naranja"], correct: 2, hint: "Les gusta a los jabal√≠es" },
                    { q: "¬øQu√© cereal se cosecha en oto√±o?", a: ["Ma√≠z", "Arroz", "Trigo", "Cebada"], correct: 2, hint: "Para hacer pan" },
                    { q: "¬øQu√© verdura es morada y se planta en oto√±o?", a: ["Zanahoria", "Berenjena", "Papa", "Cebolla"], correct: 1, hint: "Larga y morada" },
                    { q: "¬øQu√© √°rbol pierde sus hojas en oto√±o?", a: ["Pino", "Roble", "Palmera", "Cactus"], correct: 1, hint: "Hojas caducas" },
                    
                    // INVIERNO (5 preguntas)
                    { q: "¬øQu√© se puede cultivar en invernadero en invierno?", a: ["Fresa", "Lechuga", "Tomate", "Todas"], correct: 3, hint: "Protegidas del fr√≠o" },
                    { q: "¬øQu√© necesita protecci√≥n del fr√≠o en invierno?", a: ["Las ra√≠ces", "Las hojas", "Las flores", "El tallo"], correct: 0, hint: "Parte subterr√°nea" },
                    { q: "¬øQu√© cultivo resiste mejor el fr√≠o?", a: ["Espinaca", "Sand√≠a", "Ma√≠z", "Tomate"], correct: 0, hint: "Verde y de hojas" },
                    { q: "¬øQu√© se usa para proteger plantas del fr√≠o?", a: ["Invernadero", "Ventilador", "Aspersor", "Podadora"], correct: 0, hint: "Estructura de cristal" },
                    { q: "¬øQu√© hacen muchas plantas en invierno?", a: ["Crecen r√°pido", "Descansan", "Florecen", "Dan frutos"], correct: 1, hint: "Periodo de dormancia" }
                ],
                
                // PESCA - 20 preguntas
                1: [
                    { q: "¬øD√≥nde viven la mayor√≠a de los peces?", a: ["En el bosque", "En el agua", "En el cielo", "En la monta√±a"], correct: 1, hint: "Necesitan nadar" },
                    { q: "¬øQu√© usas para atrapar un pez?", a: ["Red", "Cesta", "Cuerda", "Todos"], correct: 3, hint: "Puedes usar varios m√©todos" },
                    { q: "¬øQu√© pez es conocido por sus rayas negras?", a: ["Salm√≥n", "At√∫n", "Pez payaso", "Tibur√≥n"], correct: 2, hint: "Vive con an√©monas" },
                    { q: "¬øQu√© animal marino tiene 8 tent√°culos?", a: ["Estrella de mar", "Pulpo", "Medusa", "Cangrejo"], correct: 1, hint: "Es muy inteligente" },
                    { q: "¬øPor qu√© es importante no pescar demasiado?", a: ["Para que no se acaben", "Porque es aburrido", "Porque es caro", "Porque duele"], correct: 0, hint: "Para que haya peces ma√±ana" },
                    { q: "¬øQu√© pez puede saltar fuera del agua?", a: ["Tibur√≥n", "Salm√≥n", "Pez globo", "Anguila"], correct: 1, hint: "Sube r√≠os" },
                    { q: "¬øQu√© pez tiene dientes muy afilados?", a: ["Pez payaso", "Pira√±a", "Pez √°ngel", "Pez dorado"], correct: 1, hint: "Vive en r√≠os sudamericanos" },
                    { q: "¬øQu√© pez cambia de color?", a: ["Tibur√≥n", "Pez loro", "Pez gato", "Sardina"], correct: 1, hint: "Tiene pico como loro" },
                    { q: "¬øQu√© pez puede caminar fuera del agua?", a: ["Pez sapo", "Pez globo", "Pez luna", "Pez espada"], correct: 0, hint: "Con aletas modificadas" },
                    { q: "¬øQu√© pez vive en agua dulce?", a: ["Tibur√≥n", "At√∫n", "Trucha", "Pez payaso"], correct: 2, hint: "En r√≠os y lagos" },
                    { q: "¬øQu√© pez vive en agua salada?", a: ["Pez gato", "Tibur√≥n", "Carpita", "Trucha"], correct: 1, hint: "En el mar" },
                    { q: "¬øQu√© pez puede generar electricidad?", a: ["Pez raya", "Anguila el√©ctrica", "Pez espada", "Pez luna"], correct: 1, hint: "Da descargas" },
                    { q: "¬øQu√© pez tiene forma de disco?", a: ["Pez globo", "Pez disco", "Pez luna", "Pez gato"], correct: 1, hint: "Redondo y plano" },
                    { q: "¬øQu√© pez tiene bigotes?", a: ["Pez gato", "Pez dorado", "Pez payaso", "Pez √°ngel"], correct: 0, hint: "Barbillones" },
                    { q: "¬øQu√© pez es conocido por migrar?", a: ["Pez globo", "Salm√≥n", "Pez payaso", "Pez luna"], correct: 1, hint: "Vuelve a donde naci√≥" },
                    { q: "¬øQu√© pez puede inflarse?", a: ["Pez globo", "Pez espada", "Pez loro", "Pez √°ngel"], correct: 0, hint: "Como defensa" },
                    { q: "¬øQu√© pez tiene forma de serpiente?", a: ["Anguila", "Pez payaso", "Pez dorado", "Pez gato"], correct: 0, hint: "Largo y delgado" },
                    { q: "¬øQu√© pez tiene manchas como leopardo?", a: ["Pez leopardo", "Pez cebra", "Pez tigre", "Pez jaguar"], correct: 0, hint: "Patrones de manchas" },
                    { q: "¬øQu√© pez tiene rayas como cebra?", a: ["Pez leopardo", "Pez cebra", "Pez tigre", "Pez jaguar"], correct: 1, hint: "Rayas blancas y negras" },
                    { q: "¬øQu√© pez tiene forma de flecha?", a: ["Pez flecha", "Pez arco√≠ris", "Pez hacha", "Pez mariposa"], correct: 0, hint: "Delgado y r√°pido" }
                ],
                
                // GANADER√çA - 20 preguntas
                2: [
                    { q: "¬øQu√© animal da leche?", a: ["Gallina", "Vaca", "Cerdo", "Oveja"], correct: 1, hint: "Es grande con manchas" },
                    { q: "¬øQu√© animal pone huevos?", a: ["Vaca", "Conejo", "Gallina", "Cabra"], correct: 2, hint: "Hace 'cococo'" },
                    { q: "¬øDe qu√© animal obtenemos lana?", a: ["Cerdo", "Pato", "Oveja", "Caballo"], correct: 2, hint: "Parece una nube" },
                    { q: "¬øQu√© animal hace 'oink oink'?", a: ["Vaca", "Cerdo", "Gallina", "Cabra"], correct: 1, hint: "Le gusta el barro" },
                    { q: "¬øQu√© necesitan todos los animales?", a: ["Comida y agua", "TV y radio", "Ropa y zapatos", "Libros y cuadernos"], correct: 0, hint: "Sin esto no viven" },
                    { q: "¬øQu√© animal da miel?", a: ["Abeja", "Mariposa", "Hormiga", "Grillo"], correct: 0, hint: "Hace panal" },
                    { q: "¬øQu√© animal da seda?", a: ["Ara√±a", "Gusano de seda", "Mariposa", "Oruga"], correct: 1, hint: "Hace capullo" },
                    { q: "¬øQu√© animal tira del arado?", a: ["Perro", "Caballo", "Gato", "Gallina"], correct: 1, hint: "Se monta tambi√©n" },
                    { q: "¬øQu√© animal cuida el reba√±o?", a: ["Perro pastor", "Gato", "Gallina", "Pato"], correct: 0, hint: "Ladra y gu√≠a" },
                    { q: "¬øQu√© animal da plumas?", a: ["Vaca", "Cerdo", "Pato", "Oveja"], correct: 2, hint: "Para almohadas" },
                    { q: "¬øQu√© animal come hierba?", a: ["Vaca", "Gato", "Perro", "Gallina"], correct: 0, hint: "Rumia" },
                    { q: "¬øQu√© animal come granos?", a: ["Gallina", "Vaca", "Cerdo", "Oveja"], correct: 0, hint: "Picotea" },
                    { q: "¬øQu√© animal vive en el establo?", a: ["Caballo", "Pato", "Gallina", "Todos"], correct: 3, hint: "Depende del animal" },
                    { q: "¬øQu√© animal necesita ba√±arse en agua?", a: ["Pato", "Vaca", "Oveja", "Cerdo"], correct: 0, hint: "Nada" },
                    { q: "¬øQu√© animal necesita esquilarse?", a: ["Vaca", "Oveja", "Cerdo", "Gallina"], correct: 1, hint: "Para quitar lana" },
                    { q: "¬øQu√© animal necesita herraduras?", a: ["Caballo", "Vaca", "Cerdo", "Oveja"], correct: 0, hint: "En los cascos" },
                    { q: "¬øQu√© animal da cuero?", a: ["Vaca", "Gallina", "Pato", "Conejo"], correct: 0, hint: "De su piel" },
                    { q: "¬øQu√© animal es omn√≠voro?", a: ["Cerdo", "Vaca", "Oveja", "Caballo"], correct: 0, hint: "Come de todo" },
                    { q: "¬øQu√© animal es rumiante?", a: ["Vaca", "Cerdo", "Gallina", "Pato"], correct: 0, hint: "Tiene varias bocas" },
                    { q: "¬øQu√© animal tiene pezu√±as?", a: ["Caballo", "Perro", "Gato", "Gallina"], correct: 0, hint: "Para correr" }
                ],
                
                // MINER√çA - 20 preguntas
                3: [
                    { q: "¬øQu√© usamos para romper rocas?", a: ["Martillo", "Pico", "Paleta", "Cuchillo"], correct: 1, hint: "Tiene punta afilada" },
                    { q: "¬øQu√© metal es amarillo y valioso?", a: ["Hierro", "Cobre", "Oro", "Plata"], correct: 2, hint: "Los piratas lo buscan" },
                    { q: "¬øD√≥nde se encuentra el carb√≥n?", a: ["En el cielo", "Bajo tierra", "En el mar", "En los √°rboles"], correct: 1, hint: "Es negro como la noche" },
                    { q: "¬øQu√© piedra preciosa es roja?", a: ["Zafiro", "Rub√≠", "Esmeralda", "Diamante"], correct: 1, hint: "Color de sangre" },
                    { q: "¬øPor qu√© usamos casco en minas?", a: ["Por moda", "Para ver mejor", "Para proteger cabeza", "Para o√≠r mejor"], correct: 2, hint: "Evita golpes" },
                    { q: "¬øQu√© metal es rojizo?", a: ["Oro", "Cobre", "Plata", "Plomo"], correct: 1, hint: "Para cables" },
                    { q: "¬øQu√© mineral es negro y se quema?", a: ["Carb√≥n", "Cuarzo", "M√°rmol", "Granito"], correct: 0, hint: "Para calentar" },
                    { q: "¬øQu√© piedra es transparente y valiosa?", a: ["Diamante", "Granito", "Pizarra", "Arenisca"], correct: 0, hint: "El m√°s duro" },
                    { q: "¬øQu√© metal es pesado y gris?", a: ["Plomo", "Oro", "Plata", "Cobre"], correct: 0, hint: "T√≥xico" },
                    { q: "¬øQu√© piedra tiene capas?", a: ["Pizarra", "M√°rmol", "Granito", "Cuarzo"], correct: 0, hint: "Para pizarras" },
                    { q: "¬øQu√© mineral es blanco y suave?", a: ["Talco", "Diamante", "Rub√≠", "Esmeralda"], correct: 0, hint: "Para polvos" },
                    { q: "¬øQu√© piedra es verde?", a: ["Esmeralda", "Rub√≠", "Zafiro", "Diamante"], correct: 0, hint: "Piedra preciosa" },
                    { q: "¬øQu√© mineral es azul?", a: ["Zafiro", "Rub√≠", "Esmeralda", "Diamante"], correct: 0, hint: "Piedra preciosa" },
                    { q: "¬øQu√© metal se oxida?", a: ["Hierro", "Oro", "Plata", "Cobre"], correct: 0, hint: "Se pone marr√≥n" },
                    { q: "¬øQu√© mineral es cristalino?", a: ["Cuarzo", "Carb√≥n", "Hierro", "Cobre"], correct: 0, hint: "Transparente" },
                    { q: "¬øQu√© piedra se usa para construcci√≥n?", a: ["Granito", "Diamante", "Rub√≠", "Esmeralda"], correct: 0, hint: "Muy dura" },
                    { q: "¬øQu√© metal es buen conductor?", a: ["Cobre", "Plomo", "Oro", "Plata"], correct: 0, hint: "Para electricidad" },
                    { q: "¬øQu√© mineral es salado?", a: ["Sal", "Azufre", "Cuarzo", "Mica"], correct: 0, hint: "Para cocinar" },
                    { q: "¬øQu√© piedra flota en el agua?", a: ["Piedra p√≥mez", "Granito", "M√°rmol", "Pizarra"], correct: 0, hint: "Con burbujas" },
                    { q: "¬øQu√© metal es l√≠quido a temperatura ambiente?", a: ["Mercurio", "Oro", "Plata", "Cobre"], correct: 0, hint: "T√≥xico" }
                ],
                
                // TECNOLOG√çA - 20 preguntas (arregladas)
                4: [
                    { q: "¬øQu√© m√°quina riega solo las plantas?", a: ["Sprinkler", "Tractor", "Cosechadora", "Podadora"], correct: 0, hint: "Roc√≠a agua como lluvia" },
                    { q: "¬øQu√© hace un invernadero?", a: ["Protege del fr√≠o", "Da sombra", "Ahuyenta p√°jaros", "Hace m√∫sica"], correct: 0, hint: "Permite cultivar en invierno" },
                    { q: "¬øQu√© convierte leche en queso?", a: ["Licuadora", "Quesera", "Horno", "Nevera"], correct: 1, hint: "Empieza con Q" },
                    { q: "¬øQu√© ayuda a las plantas a crecer mejor?", a: ["Fertilizante", "Pintura", "Jab√≥n", "Aceite"], correct: 0, hint: "Como vitaminas para plantas" },
                    { q: "¬øQu√© usa energ√≠a solar en la granja?", a: ["Paneles solares", "Molino viento", "Generador", "Bater√≠as"], correct: 0, hint: "Usa el sol" },
                    { q: "¬øQu√© m√°quina hace jugo de frutas?", a: ["Keg", "Tractor", "Horno", "Licuadora"], correct: 0, hint: "Para fermentar" },
                    { q: "¬øQu√© hace un molino de viento?", a: ["Genera electricidad", "Riega plantas", "Cosecha trigo", "Muele grano"], correct: 0, hint: "Con aspas" },
                    { q: "¬øQu√© m√°quina orde√±a vacas?", a: ["Orde√±adora", "Tractor", "Cosechadora", "Podadora"], correct: 0, hint: "Autom√°tica" },
                    { q: "¬øQu√© conserva alimentos fr√≠os?", a: ["Refrigerador", "Horno", "Lavadora", "Secadora"], correct: 0, hint: "Para no pudrirse" },
                    { q: "¬øQu√© m√°quina corta c√©sped?", a: ["Cortadora", "Tractor", "Cosechadora", "Podadora"], correct: 0, hint: "Con cuchillas" },
                    { q: "¬øQu√© procesa la lana?", a: ["Cardadora", "Tractor", "Horno", "Licuadora"], correct: 0, hint: "Para hilar" },
                    { q: "¬øQu√© hace la mantequilla?", a: ["Mantequillera", "Quesera", "Keg", "Horno"], correct: 0, hint: "De la crema" },
                    { q: "¬øQu√© sistema usa GPS en agricultura?", a: ["Agricultura precisi√≥n", "Riego", "Cosecha", "Siembra"], correct: 0, hint: "Con sat√©lites" },
                    { q: "¬øQu√© mide la humedad del suelo?", a: ["Sensor humedad", "Term√≥metro", "Bar√≥metro", "Pluvi√≥metro"], correct: 0, hint: "Para saber regar" },
                    { q: "¬øQu√© controla el riego autom√°tico?", a: ["Temporizador", "Term√≥metro", "Bar√≥metro", "Pluvi√≥metro"], correct: 0, hint: "Programable" },
                    { q: "¬øQu√© m√°quina siembra semillas?", a: ["Sembradora", "Tractor", "Cosechadora", "Podadora"], correct: 0, hint: "Autom√°tica" },
                    { q: "¬øQu√© limpia el grano?", a: ["Limpia granos", "Tractor", "Horno", "Licuadora"], correct: 0, hint: "Quita impurezas" },
                    { q: "¬øQu√© hace compost?", a: ["Compostera", "Horno", "Refrigerador", "Lavadora"], correct: 0, hint: "De desechos" },
                    { q: "¬øQu√© pasteuriza la leche?", a: ["Pasteurizador", "Horno", "Refrigerador", "Licuadora"], correct: 0, hint: "Para conservar" },
                    { q: "¬øQu√© envasa alimentos?", a: ["Envasadora", "Tractor", "Cosechadora", "Podadora"], correct: 0, hint: "Al vac√≠o" }
                ]
            },

            // Items de tienda
            shopItems: [
                { id: 1, name: "Vida Extra", icon: "‚ù§Ô∏è", price: 50, effect: "addHeart", desc: "+1 coraz√≥n" },
                { id: 2, name: "Tiempo Extra", icon: "‚è∞", price: 40, effect: "addTime", desc: "+10 segundos" },
                { id: 3, name: "Pistas Extra", icon: "üí°", price: 30, effect: "addHints", desc: "+3 pistas" },
                { id: 4, name: "Ca√±a Iridio", icon: "üé£", price: 100, effect: "iridiumRod", desc: "Pesca + f√°cil" },
                { id: 5, name: "Semillas Mejoradas", icon: "üåü", price: 60, effect: "betterSeeds", desc: "+50% puntos" }
            ],

            // Estado del juego
            state: {
                totalPoints: 0,
                currentLevel: 0,
                currentQuestion: 0,
                questionsAnswered: 0,
                hearts: 5,
                hints: 3,
                timeLeft: 30,
                timer: null,
                selectedAnswer: null,
                minigameActive: false,
                timePaused: false,
                shopOpen: false,
                characterVisible: false
            },

            // Estados de minijuegos
            minigames: {
                current: null,
                score: 0,
                active: false,
                interval: null,
                keys: {}
            }
        };

        // ==================== INICIALIZACI√ìN ====================
        function initGame() {
            // Cargar primer nivel
            loadLevel(0);
            
            // Iniciar temporizador
            startTimer();
            
            showMessage("¬°Bienvenido a Stardew Valley Trivia! Responde 20 preguntas por nivel.");
            
            // Prevenir comportamiento por defecto de espacio
            document.addEventListener('keydown', function(e) {
                if (e.key === ' ' && GAME.minigames.active) {
                    e.preventDefault();
                }
            });
        }

        // ==================== SISTEMA DE NIVELES ====================
        function loadLevel(levelId) {
            const level = GAME.levels[levelId];
            
            // Verificar si el nivel est√° desbloqueado
            if (!level.unlocked && levelId > 0) {
                showMessage("¬°Debes completar el nivel anterior primero!");
                return;
            }
            
            // Resetear estado del nivel
            GAME.state.currentLevel = levelId;
            GAME.state.currentQuestion = 0;
            GAME.state.questionsAnswered = 0;
            GAME.state.hints = 3;
            GAME.state.selectedAnswer = null;
            GAME.state.minigameActive = false;
            
            // Actualizar UI
            document.querySelectorAll('.level-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === levelId);
                // Habilitar solo niveles desbloqueados
                btn.disabled = !GAME.levels[idx].unlocked;
            });
            
            document.getElementById('level-icon').textContent = level.icon;
            document.getElementById('level-title').textContent = level.name;
            document.getElementById('current-level').textContent = levelId + 1;
            
            // Aplicar tema visual al panel de preguntas
            const questionsPanel = document.getElementById('questions-panel');
            questionsPanel.className = 'game-panel questions-panel';
            questionsPanel.classList.add(`theme-${level.theme}`);
            
            // Limpiar efectos especiales previos
            document.querySelectorAll('.greenhouse-effect, .greenhouse-plants').forEach(el => el.remove());
            
            // A√±adir efecto de invernadero para tecnolog√≠a
            if (levelId === 4) {
                const greenhouseEffect = document.createElement('div');
                greenhouseEffect.className = 'greenhouse-effect';
                questionsPanel.appendChild(greenhouseEffect);
                
                const greenhousePlants = document.createElement('div');
                greenhousePlants.className = 'greenhouse-plants';
                questionsPanel.appendChild(greenhousePlants);
                
                // A√±adir fondo pixel art
                const pixelBg = document.querySelector('.pixel-background');
                if (pixelBg) pixelBg.className = 'pixel-background bg-tecnologia';
            } else {
                // Cambiar fondo pixel art seg√∫n tema
                const pixelBg = document.querySelector('.pixel-background');
                if (pixelBg) pixelBg.className = `pixel-background bg-${level.theme}`;
            }
            
            // Actualizar corazones
            updateHearts();
            
            // Actualizar inventario
            updateInventory();
            
            // Actualizar botones
            document.getElementById('hint-btn').textContent = `üí° Pista (${GAME.state.hints})`;
            document.getElementById('minigame-btn').disabled = true;
            
            // Ocultar minijuego si est√° activo
            backToTrivia();
            
            // Cargar primera pregunta
            loadQuestion();
            
            showMessage(`Nivel cargado: ${level.name} - ${level.questions} preguntas`);
        }

        function updateInventory() {
            const level = GAME.levels[GAME.state.currentLevel];
            const toolsGrid = document.querySelector('.tools-grid');
            
            toolsGrid.innerHTML = '';
            
            level.tools.forEach((tool, index) => {
                const toolDiv = document.createElement('div');
                toolDiv.className = 'tool-item';
                if (index === 0) toolDiv.classList.add('active');
                toolDiv.onclick = () => selectTool(index);
                toolDiv.innerHTML = `
                    <span class="tool-icon">${tool.icon}</span>
                    <div class="tool-name">${tool.name}</div>
                `;
                toolsGrid.appendChild(toolDiv);
            });
        }

        function selectTool(index) {
            document.querySelectorAll('.tool-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.tool-item')[index].classList.add('active');
            
            const tool = GAME.levels[GAME.state.currentLevel].tools[index];
            showMessage(`Seleccionado: ${tool.name} - ${tool.desc}`);
        }

        // ==================== SISTEMA DE PREGUNTAS ====================
        function loadQuestion() {
            const level = GAME.state.currentLevel;
            const question = GAME.questions[level][GAME.state.currentQuestion];
            
            if (!question) {
                completeLevel();
                return;
            }
            
            // Actualizar UI
            document.getElementById('question-text').textContent = question.q;
            document.getElementById('current-question').textContent = `${GAME.state.currentQuestion + 1}/${GAME.levels[level].questions}`;
            document.getElementById('level-progress').textContent = `Pregunta ${GAME.state.currentQuestion + 1} de ${GAME.levels[level].questions}`;
            document.getElementById('progress-fill').style.width = `${(GAME.state.questionsAnswered / GAME.levels[level].questions) * 100}%`;
            
            // Cargar opciones
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.a.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(button);
            });
            
            // Resetear selecci√≥n
            document.getElementById('submit-btn').disabled = true;
            GAME.state.selectedAnswer = null;
            
            // Reiniciar temporizador
            resetTimer();
            
            // Ocultar personaje si est√° visible
            hideCharacter();
        }

        function selectAnswer(index) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Marcar nueva selecci√≥n
            const buttons = document.querySelectorAll('.option-btn');
            buttons[index].classList.add('selected');
            
            // Habilitar bot√≥n de enviar
            document.getElementById('submit-btn').disabled = false;
            GAME.state.selectedAnswer = index;
        }

        function submitAnswer() {
            if (GAME.state.selectedAnswer === null) return;
            
            const level = GAME.state.currentLevel;
            const question = GAME.questions[level][GAME.state.currentQuestion];
            const buttons = document.querySelectorAll('.option-btn');
            
            // Deshabilitar interacci√≥n
            buttons.forEach(btn => btn.disabled = true);
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('hint-btn').disabled = true;
            
            // Detener temporizador
            clearInterval(GAME.state.timer);
            
            // Marcar respuestas correctas/incorrectas
            buttons.forEach((btn, index) => {
                if (index === question.correct) {
                    btn.classList.add('correct');
                } else if (index === GAME.state.selectedAnswer) {
                    btn.classList.add('incorrect');
                }
            });
            
            // Verificar respuesta
            if (GAME.state.selectedAnswer === question.correct) {
                // Respuesta correcta
                GAME.state.totalPoints += 10;
                GAME.state.questionsAnswered++;
                showMessage("¬°Correcto! +10 puntos");
                
                // Actualizar puntos
                document.getElementById('total-points').textContent = GAME.state.totalPoints;
            } else {
                // Respuesta incorrecta
                GAME.state.hearts--;
                updateHearts();
                showMessage(`Incorrecto. La respuesta correcta es: "${question.a[question.correct]}"`);
                
                if (GAME.state.hearts <= 0) {
                    setTimeout(gameOver, 1000);
                    return;
                }
            }
            
            // Actualizar progreso
            document.getElementById('progress-fill').style.width = `${(GAME.state.questionsAnswered / GAME.levels[level].questions) * 100}%`;
            
            // Pasar a siguiente pregunta despu√©s de 2 segundos
            setTimeout(() => {
                GAME.state.currentQuestion++;
                
                if (GAME.state.currentQuestion < GAME.levels[level].questions) {
                    loadQuestion();
                    document.getElementById('hint-btn').disabled = false;
                    startTimer();
                } else {
                    completeLevel();
                }
            }, 2000);
        }

        function completeLevel() {
            const level = GAME.levels[GAME.state.currentLevel];
            
            // Marcar nivel como completado
            level.completed = true;
            
            // Desbloquear siguiente nivel si existe
            if (GAME.state.currentLevel < GAME.levels.length - 1) {
                GAME.levels[GAME.state.currentLevel + 1].unlocked = true;
                document.getElementById(`level-btn-${GAME.state.currentLevel + 1}`).disabled = false;
            }
            
            // Dar puntos por completar nivel
            GAME.state.totalPoints += 200;
            document.getElementById('total-points').textContent = GAME.state.totalPoints;
            
            // Habilitar minijuego
            document.getElementById('minigame-btn').disabled = false;
            
            // Mostrar personaje felicitando
            showCharacter(level.character, `¬°${level.name} completado! +200 puntos. ¬°Ahora juega el minijuego!`);
            
            // Ocultar personaje despu√©s de 5 segundos
            setTimeout(hideCharacter, 5000);
        }

        // ==================== SISTEMA DE PISTAS CON PERSONAJES ====================
        function useHint() {
            if (GAME.state.hints <= 0) {
                showMessage("No tienes m√°s pistas");
                return;
            }
            
            GAME.state.hints--;
            document.getElementById('hint-btn').textContent = `üí° Pista (${GAME.state.hints})`;
            
            const level = GAME.state.currentLevel;
            const question = GAME.questions[level][GAME.state.currentQuestion];
            
            // Mostrar pista con personaje
            const levelData = GAME.levels[level];
            showCharacter(levelData.character, `üí° Pista: ${question.hint}`);
            
            // Ocultar personaje despu√©s de 4 segundos
            setTimeout(hideCharacter, 4000);
        }

        // ==================== SISTEMA DE PERSONAJES ====================
        function showCharacter(characterType, message) {
            const characterHelp = document.getElementById('character-help');
            const characterImg = document.getElementById('character-img');
            const characterSpeech = document.getElementById('character-speech');
            
            // Configurar personaje
            characterImg.src = GAME.characters[characterType];
            characterImg.alt = `Personaje de ${characterType}`;
            characterSpeech.textContent = message;
            
            // Mostrar personaje con animaci√≥n
            characterHelp.style.display = 'block';
            characterHelp.style.transform = 'translateX(100px)';
            characterHelp.style.opacity = '0';
            
            setTimeout(() => {
                characterHelp.style.transform = 'translateX(0)';
                characterHelp.style.opacity = '1';
            }, 10);
            
            GAME.state.characterVisible = true;
        }

        function hideCharacter() {
            if (!GAME.state.characterVisible) return;
            
            const characterHelp = document.getElementById('character-help');
            characterHelp.style.transform = 'translateX(100px)';
            characterHelp.style.opacity = '0';
            
            setTimeout(() => {
                characterHelp.style.display = 'none';
                GAME.state.characterVisible = false;
            }, 500);
        }

        // ==================== SISTEMA DE TIEMPO ====================
        function startTimer() {
            if (GAME.state.timePaused) return;
            
            clearInterval(GAME.state.timer);
            GAME.state.timeLeft = 30;
            updateTimerDisplay();
            
            GAME.state.timer = setInterval(() => {
                if (!GAME.state.timePaused) {
                    GAME.state.timeLeft--;
                    updateTimerDisplay();
                    
                    if (GAME.state.timeLeft <= 0) {
                        clearInterval(GAME.state.timer);
                        timeUp();
                    }
                }
            }, 1000);
        }

        function resetTimer() {
            GAME.state.timeLeft = 30;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const timerBox = document.getElementById('timer-box');
            const timerText = document.getElementById('timer');
            
            timerText.textContent = GAME.state.timeLeft;
            document.getElementById('time-left').textContent = `${GAME.state.timeLeft}s`;
            
            // Cambiar color seg√∫n tiempo
            timerBox.className = 'timer-box';
            if (GAME.state.timeLeft <= 10) {
                timerBox.classList.add('danger');
            } else if (GAME.state.timeLeft <= 20) {
                timerBox.classList.add('warning');
            }
        }

        function timeUp() {
            GAME.state.hearts--;
            updateHearts();
            showMessage("¬°Se acab√≥ el tiempo! Pierdes un coraz√≥n.");
            
            if (GAME.state.hearts <= 0) {
                setTimeout(gameOver, 1000);
                return;
            }
            
            // Pasar autom√°ticamente a siguiente pregunta
            setTimeout(() => {
                GAME.state.currentQuestion++;
                if (GAME.state.currentQuestion < GAME.levels[GAME.state.currentLevel].questions) {
                    loadQuestion();
                    startTimer();
                } else {
                    completeLevel();
                }
            }, 2000);
        }

        function updateHearts() {
            let heartsHTML = '';
            for (let i = 0; i < 5; i++) {
                heartsHTML += i < GAME.state.hearts ? '‚ù§Ô∏è' : 'ü§ç';
            }
            document.getElementById('hearts-display').innerHTML = heartsHTML;
        }

        // ==================== MINIJUEGOS COMPLETOS ====================
        function startMinigame() {
            const level = GAME.levels[GAME.state.currentLevel];
            GAME.minigames.current = level.minigame;
            GAME.minigames.score = 0;
            GAME.minigames.active = true;
            
            // Ocultar inventario y mostrar minijuego
            document.getElementById('inventory-content').style.display = 'none';
            document.getElementById('minigame-container').style.display = 'flex';
            document.getElementById('minigame-btn').disabled = true;
            
            // Configurar minijuego espec√≠fico
            switch(level.minigame) {
                case 'planting':
                    startPlantingGame();
                    break;
                case 'fishing':
                    startFishingGame();
                    break;
                case 'animals':
                    startAnimalsGame();
                    break;
                case 'mining':
                    startMiningGame();
                    break;
                case 'technology':
                    startTechnologyGame();
                    break;
            }
            
            showMessage(`¬°Minijuego de ${level.name} iniciado!`);
        }

        function backToTrivia() {
            // Detener minijuego activo
            if (GAME.minigames.interval) {
                clearInterval(GAME.minigames.interval);
                GAME.minigames.interval = null;
            }
            
            // Limpiar eventos de teclado
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
            
            GAME.minigames.active = false;
            GAME.minigames.keys = {};
            
            // Mostrar inventario y ocultar minijuego
            document.getElementById('inventory-content').style.display = 'block';
            document.getElementById('minigame-container').style.display = 'none';
            
            // Limpiar canvas
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function restartMinigame() {
            if (GAME.minigames.active) {
                backToTrivia();
                startMinigame();
            }
        }

        // Control de teclado para minijuegos
        function handleKeyDown(e) {
            if (GAME.minigames.active) {
                GAME.minigames.keys[e.key.toLowerCase()] = true;
                if (e.key === ' ') {
                    e.preventDefault(); // Prevenir scroll de espacio
                }
            }
        }

        function handleKeyUp(e) {
            if (GAME.minigames.active) {
                GAME.minigames.keys[e.key.toLowerCase()] = false;
            }
        }

        // ==================== MINIJUEGO 1: PLANTACI√ìN (MODIFICADO) ====================
        function startPlantingGame() {
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            
            const game = {
                player: { x: 200, y: 150, size: 20, speed: 4 },
                plots: [],
                seeds: [],
                plants: [],
                score: 0,
                time: 60,
                water: 100,
                selectedTool: 0,
                tools: ['‚õèÔ∏è', 'üçì', 'üíß']
            };
            
            // Crear parcelas
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    game.plots.push({
                        x: 50 + i * 100,
                        y: 50 + j * 80,
                        width: 80,
                        height: 60,
                        tilled: false,
                        planted: false,
                        watered: false,
                        growth: 0
                    });
                }
            }
            
            // Configurar UI
            document.getElementById('minigame-title').textContent = "üå± MINIJUEGO DE AGRICULTURA";
            document.getElementById('minigame-controls').innerHTML = 
                "CONTROLES: WASD mover, ESPACIO usar herramienta, 1-3 cambiar herramienta";
            
            // Dibujar juego
            function draw() {
                // Limpiar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Dibujar fondo de campo
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Dibujar parcelas
                game.plots.forEach(plot => {
                    // Tierra
                    ctx.fillStyle = plot.tilled ? '#8B4513' : '#654321';
                    ctx.fillRect(plot.x, plot.y, plot.width, plot.height);
                    
                    // Borde
                    ctx.strokeStyle = '#2c3e50';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(plot.x, plot.y, plot.width, plot.height);
                    
                    // Si est√° plantada
                    if (plot.planted) {
                        // Planta
                        const plantHeight = 10 + plot.growth;
                        ctx.fillStyle = '#2ecc71';
                        ctx.fillRect(plot.x + plot.width/2 - 2, plot.y + plot.height - plantHeight, 4, plantHeight);
                        
                        // Fruto si est√° madura
                        if (plot.growth >= 40) {
                            ctx.fillStyle = '#e74c3c';
                            ctx.beginPath();
                            ctx.arc(plot.x + plot.width/2, plot.y + plot.height - plantHeight - 5, 6, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                    
                    // Indicador de regado
                    if (plot.watered) {
                        ctx.fillStyle = '#3498db';
                        ctx.fillRect(plot.x + 5, plot.y + 5, 10, 10);
                    }
                });
                
                // Dibujar jugador
                ctx.fillStyle = '#f1c40f';
                ctx.fillRect(game.player.x - game.player.size/2, game.player.y - game.player.size, game.player.size, game.player.size);
                
                // Dibujar herramienta
                ctx.font = '20px Arial';
                ctx.fillText(game.tools[game.selectedTool], game.player.x - 5, game.player.y - game.player.size - 5);
                
                // Dibujar informaci√≥n
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '14px Courier New';
                ctx.fillText(`Puntos: ${game.score}`, 10, 20);
                ctx.fillText(`Tiempo: ${Math.ceil(game.time)}s`, 10, 40);
                ctx.fillText(`Agua: ${game.water}`, 10, 60);
                ctx.fillText(`Herramienta: ${game.selectedTool + 1}`, 10, 80);
                
                // Leyenda de herramientas
                ctx.fillText("1: Azada ‚õèÔ∏è", 280, 20);
                ctx.fillText("2: Semillas üçì", 280, 40);
                ctx.fillText("3: Regadera üíß", 280, 60);
            }
            
            // Actualizar juego
            function update() {
                // Mover jugador
                if (GAME.minigames.keys['w'] && game.player.y > 30) game.player.y -= game.player.speed;
                if (GAME.minigames.keys['s'] && game.player.y < 270) game.player.y += game.player.speed;
                if (GAME.minigames.keys['a'] && game.player.x > 20) game.player.x -= game.player.speed;
                if (GAME.minigames.keys['d'] && game.player.x < 380) game.player.x += game.player.speed;
                
                // Cambiar herramienta
                if (GAME.minigames.keys['1']) game.selectedTool = 0;
                if (GAME.minigames.keys['2']) game.selectedTool = 1;
                if (GAME.minigames.keys['3']) game.selectedTool = 2;
                
                // Usar herramienta (ESPACIO)
                if (GAME.minigames.keys[' ']) {
                    // Buscar parcela m√°s cercana
                    let closestPlot = null;
                    let minDist = Infinity;
                    
                    game.plots.forEach(plot => {
                        const dist = Math.sqrt(
                            Math.pow(plot.x + plot.width/2 - game.player.x, 2) + 
                            Math.pow(plot.y + plot.height/2 - game.player.y, 2)
                        );
                        
                        if (dist < 50 && dist < minDist) {
                            minDist = dist;
                            closestPlot = plot;
                        }
                    });
                    
                    if (closestPlot) {
                        switch(game.selectedTool) {
                            case 0: // Azada
                                if (!closestPlot.tilled) {
                                    closestPlot.tilled = true;
                                    game.score += 5;
                                }
                                break;
                            case 1: // Semillas
                                if (closestPlot.tilled && !closestPlot.planted) {
                                    closestPlot.planted = true;
                                    closestPlot.growth = 5;
                                    game.score += 10;
                                }
                                break;
                            case 2: // Regadera
                                if (closestPlot.planted && game.water > 0 && !closestPlot.watered) {
                                    closestPlot.watered = true;
                                    game.water -= 10;
                                    game.score += 3;
                                }
                                break;
                        }
                    }
                    
                    // Resetear espacio para evitar uso continuo
                    GAME.minigames.keys[' '] = false;
                }
                
                // Actualizar crecimiento de plantas
                game.plots.forEach(plot => {
                    if (plot.planted && plot.watered) {
                        plot.growth += 0.5;
                        plot.watered = false; // Necesita riego de nuevo
                        
                        // Cosechar si est√° madura
                        if (plot.growth >= 50) {
                            game.score += 20;
                            plot.planted = false;
                            plot.tilled = false;
                            plot.growth = 0;
                        }
                    }
                });
                
                // Regenerar agua
                if (game.water < 100) {
                    game.water += 0.1;
                }
                
                // Actualizar tiempo
                game.time -= 1/60;
                if (game.time <= 0) {
                    endMinigame(game.score);
                }
                
                draw();
            }
            
            // Configurar eventos de teclado
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // Iniciar bucle del juego
            GAME.minigames.interval = setInterval(update, 1000/60);
            
            // Actualizar estad√≠sticas
            updateMinigameStats(game);
        }

        // ==================== MINIJUEGO 2: PESCA ====================
        function startFishingGame() {
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            
            const game = {
                fisher: { x: 200, y: 50, lineLength: 0, casting: false, reeling: false },
                fish: [],
                bubbles: [],
                score: 0,
                time: 60,
                castPower: 0,
                spacePressed: false,
                spacePressTime: 0
            };
            
            // Configurar UI
            document.getElementById('minigame-title').textContent = "üé£ MINIJUEGO DE PESCA";
            document.getElementById('minigame-controls').innerHTML = 
                "CONTROLES: ESPACIO para lanzar/recoger (mantener para cargar lanzamiento)";
            
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Agua
                ctx.fillStyle = '#2980b9';
                ctx.fillRect(0, 150, canvas.width, 150);
                
                // Olas
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 2;
                for (let i = 0; i < canvas.width; i += 30) {
                    ctx.beginPath();
                    ctx.moveTo(i, 150 + Math.sin(Date.now()/1000 + i/30) * 5);
                    ctx.lineTo(i + 30, 150 + Math.sin(Date.now()/1000 + (i+30)/30) * 5);
                    ctx.stroke();
                }
                
                // Pescador
                ctx.fillStyle = '#34495e';
                ctx.fillRect(game.fisher.x - 10, game.fisher.y, 20, 30);
                
                // Ca√±a
                ctx.strokeStyle = '#7f8c8d';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(game.fisher.x, game.fisher.y + 10);
                ctx.lineTo(game.fisher.x, game.fisher.y + 30);
                ctx.stroke();
                
                if (game.fisher.casting) {
                    // L√≠nea
                    const endX = game.fisher.x;
                    const endY = game.fisher.y + 30 + game.fisher.lineLength;
                    
                    ctx.strokeStyle = '#ecf0f1';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(game.fisher.x, game.fisher.y + 30);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                    
                    // Anzuelo
                    ctx.fillStyle = '#f1c40f';
                    ctx.beginPath();
                    ctx.arc(endX, endY, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Peces
                game.fish.forEach(fish => {
                    ctx.fillStyle = fish.color;
                    ctx.beginPath();
                    ctx.ellipse(fish.x, fish.y, 10, 5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Cola
                    ctx.beginPath();
                    ctx.moveTo(fish.x - 10, fish.y);
                    ctx.lineTo(fish.x - 20, fish.y - 5);
                    ctx.lineTo(fish.x - 20, fish.y + 5);
                    ctx.closePath();
                    ctx.fill();
                });
                
                // Informaci√≥n
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '14px Courier New';
                ctx.fillText(`Puntos: ${game.score}`, 10, 20);
                ctx.fillText(`Tiempo: ${Math.ceil(game.time)}s`, 10, 40);
                
                if (!game.fisher.casting) {
                    ctx.fillText('Mant√©n ESPACIO para cargar', 10, 280);
                } else {
                    ctx.fillText('Presiona ESPACIO cuando un pez muerda', 10, 280);
                }
            }
            
            function update() {
                // Crear peces
                if (Math.random() < 0.02 && game.fish.length < 6) {
                    game.fish.push({
                        x: Math.random() * canvas.width,
                        y: 170 + Math.random() * 100,
                        speed: 1 + Math.random() * 2,
                        direction: Math.random() > 0.5 ? 1 : -1,
                        color: ['#e74c3c', '#f1c40f', '#1abc9c'][Math.floor(Math.random() * 3)],
                        biting: false
                    });
                }
                
                // Actualizar peces
                game.fish.forEach(fish => {
                    fish.x += fish.speed * fish.direction;
                    
                    if (fish.x < 0 || fish.x > canvas.width) {
                        fish.direction *= -1;
                    }
                    
                    // Morder anzuelo
                    if (game.fisher.casting && !fish.biting) {
                        const hookX = game.fisher.x;
                        const hookY = game.fisher.y + 30 + game.fisher.lineLength;
                        const dist = Math.sqrt((fish.x - hookX) ** 2 + (fish.y - hookY) ** 2);
                        
                        if (dist < 15 && Math.random() < 0.01) {
                            fish.biting = true;
                        }
                    }
                    
                    // Si est√° mordiendo
                    if (fish.biting && game.fisher.casting) {
                        fish.x = game.fisher.x;
                        fish.y = game.fisher.y + 30 + game.fisher.lineLength;
                        
                        // Recoger
                        if (game.fisher.reeling) {
                            game.fisher.lineLength -= 2;
                            if (game.fisher.lineLength <= 0) {
                                game.score += fish.color === '#f1c40f' ? 30 : 20;
                                game.fish = game.fish.filter(f => f !== fish);
                            }
                        }
                    }
                });
                
                // Control de espacio
                if (GAME.minigames.keys[' ']) {
                    if (!game.spacePressed) {
                        game.spacePressed = true;
                        game.spacePressTime = Date.now();
                        
                        if (!game.fisher.casting) {
                            game.castPower = 0;
                        } else if (game.fisher.casting) {
                            game.fisher.reeling = true;
                        }
                    } else if (!game.fisher.casting) {
                        game.castPower = Math.min((Date.now() - game.spacePressTime) / 1000, 2);
                    }
                } else if (game.spacePressed) {
                    game.spacePressed = false;
                    
                    if (!game.fisher.casting) {
                        game.fisher.casting = true;
                        game.fisher.lineLength = 50 + game.castPower * 50;
                    } else if (game.fisher.casting && game.fisher.reeling) {
                        game.fisher.reeling = false;
                    }
                }
                
                // Tiempo
                game.time -= 1/60;
                if (game.time <= 0) {
                    endMinigame(game.score);
                }
                
                draw();
            }
            
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            GAME.minigames.interval = setInterval(update, 1000/60);
            updateMinigameStats(game);
        }

        // ==================== MINIJUEGO 4: MINER√çA (ARREGLADO) ====================
        function startMiningGame() {
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            
            const game = {
                player: { x: 200, y: 50, size: 20, speed: 4 },
                blocks: [],
                minerals: [],
                score: 0,
                time: 60,
                stamina: 100,
                depth: 0
            };
            
            // Crear bloques
            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 8; x++) {
                    game.blocks.push({
                        x: x * 50,
                        y: 80 + y * 40,
                        width: 50,
                        height: 40,
                        health: 100,
                        containsMineral: Math.random() > 0.6,
                        mineralType: Math.random() > 0.8 ? 'gem' : Math.random() > 0.6 ? 'gold' : 'iron'
                    });
                }
            }
            
            // Configurar UI
            document.getElementById('minigame-title').textContent = "‚õèÔ∏è MINIJUEGO DE MINER√çA";
            document.getElementById('minigame-controls').innerHTML = 
                "CONTROLES: WASD mover, ESPACIO minar, recoge minerales autom√°ticamente";
            
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Fondo cueva
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Entrada
                ctx.fillStyle = '#7f8c8d';
                ctx.fillRect(0, 0, canvas.width, 80);
                
                // Jugador
                ctx.fillStyle = '#95a5a6';
                ctx.fillRect(game.player.x - game.player.size/2, game.player.y - game.player.size, game.player.size, game.player.size);
                
                // Pico
                ctx.strokeStyle = '#34495e';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(game.player.x, game.player.y - game.player.size/2);
                ctx.lineTo(game.player.x + 15, game.player.y - game.player.size/2 - 10);
                ctx.stroke();
                
                // Bloques
                game.blocks.forEach(block => {
                    // Color seg√∫n tipo de mineral
                    let color = '#7f8c8d';
                    if (block.containsMineral) {
                        color = block.mineralType === 'gem' ? '#9b59b6' : 
                                block.mineralType === 'gold' ? '#f1c40f' : '#bdc3c7';
                    }
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(block.x, block.y, block.width, block.height);
                    
                    // Borde
                    ctx.strokeStyle = '#34495e';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(block.x, block.y, block.width, block.height);
                    
                    // Salud
                    if (block.health < 100) {
                        ctx.fillStyle = '#e74c3c';
                        ctx.fillRect(block.x, block.y + block.height - 5, (block.width * block.health) / 100, 3);
                    }
                });
                
                // Minerales
                game.minerals.forEach(mineral => {
                    ctx.fillStyle = mineral.color;
                    ctx.beginPath();
                    ctx.arc(mineral.x, mineral.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // Informaci√≥n
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '14px Courier New';
                ctx.fillText(`Puntos: ${game.score}`, 10, 20);
                ctx.fillText(`Tiempo: ${Math.ceil(game.time)}s`, 10, 40);
                ctx.fillText(`Energ√≠a: ${Math.ceil(game.stamina)}`, 10, 60);
            }
            
            function update() {
                // Mover
                if (GAME.minigames.keys['w'] && game.player.y > 30) game.player.y -= game.player.speed;
                if (GAME.minigames.keys['s'] && game.player.y < 280) game.player.y += game.player.speed;
                if (GAME.minigames.keys['a'] && game.player.x > 20) game.player.x -= game.player.speed;
                if (GAME.minigames.keys['d'] && game.player.x < 380) game.player.x += game.player.speed;
                
                // Minar (ESPACIO)
                if (GAME.minigames.keys[' '] && game.stamina >= 5) {
                    let mined = false;
                    
                    game.blocks.forEach(block => {
                        if (block.health > 0) {
                            const dist = Math.sqrt(
                                Math.pow(block.x + block.width/2 - game.player.x, 2) + 
                                Math.pow(block.y + block.height/2 - game.player.y, 2)
                            );
                            
                            if (dist < 40) {
                                block.health -= 10;
                                game.stamina -= 5;
                                game.score += 1;
                                
                                if (block.health <= 0 && block.containsMineral) {
                                    // Crear mineral
                                    const points = block.mineralType === 'gem' ? 50 : 
                                                  block.mineralType === 'gold' ? 30 : 10;
                                    const color = block.mineralType === 'gem' ? '#9b59b6' : 
                                                 block.mineralType === 'gold' ? '#f1c40f' : '#bdc3c7';
                                    
                                    game.minerals.push({
                                        x: block.x + block.width/2,
                                        y: block.y + block.height/2,
                                        points: points,
                                        color: color,
                                        type: block.mineralType
                                    });
                                    
                                    game.depth += 1;
                                }
                                mined = true;
                            }
                        }
                    });
                    
                    if (mined) {
                        GAME.minigames.keys[' '] = false; // Resetear espacio
                    }
                }
                
                // Actualizar minerales (ca√≠da)
                game.minerals.forEach(mineral => {
                    mineral.y += 1;
                    
                    // Recolectar si est√° cerca
                    const dist = Math.sqrt(
                        Math.pow(mineral.x - game.player.x, 2) + 
                        Math.pow(mineral.y - game.player.y, 2)
                    );
                    
                    if (dist < 25) {
                        game.score += mineral.points;
                        game.minerals = game.minerals.filter(m => m !== mineral);
                    }
                });
                
                // Regenerar energ√≠a
                if (game.stamina < 100) {
                    game.stamina += 0.2;
                }
                
                // Tiempo
                game.time -= 1/60;
                if (game.time <= 0) {
                    endMinigame(game.score);
                }
                
                draw();
            }
            
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            GAME.minigames.interval = setInterval(update, 1000/60);
            updateMinigameStats(game);
        }

        // ==================== MINIJUEGO 5: TECNOLOG√çA (ARREGLADO) ====================
        function startTechnologyGame() {
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            
            const game = {
                player: { x: 200, y: 150, size: 20, speed: 4 },
                machines: [],
                resources: [],
                products: [],
                score: 0,
                time: 60,
                energy: 100,
                selectedResource: null
            };
            
            // M√°quinas
            const machineData = [
                {x: 100, y: 100, type: 'sprinkler', input: 'none', output: 'agua', color: '#27ae60'},
                {x: 200, y: 100, type: 'quesera', input: 'leche', output: 'queso', color: '#f1c40f'},
                {x: 300, y: 100, type: 'mayonera', input: 'huevo', output: 'mayonesa', color: '#3498db'},
                {x: 150, y: 200, type: 'keg', input: 'fruta', output: 'jugo', color: '#8e44ad'},
                {x: 250, y: 200, type: 'incubadora', input: 'huevo', output: 'pollo', color: '#e74c3c'}
            ];
            
            machineData.forEach(data => {
                game.machines.push({
                    ...data,
                    processing: false,
                    progress: 0,
                    hasInput: false,
                    hasOutput: false
                });
            });
            
            // Configurar UI
            document.getElementById('minigame-title').textContent = "üî¨ MINIJUEGO DE TECNOLOG√çA";
            document.getElementById('minigame-controls').innerHTML = 
                "CONTROLES: WASD mover, ESPACIO usar m√°quina, R recoger recurso";
            
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Fondo
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Rejilla
                ctx.strokeStyle = '#34495e';
                ctx.lineWidth = 1;
                for (let x = 0; x < canvas.width; x += 20) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                // Jugador
                ctx.fillStyle = '#9b59b6';
                ctx.fillRect(game.player.x - game.player.size/2, game.player.y - game.player.size, game.player.size, game.player.size);
                
                // M√°quinas
                game.machines.forEach(machine => {
                    // Cuerpo
                    ctx.fillStyle = machine.color;
                    ctx.fillRect(machine.x - 25, machine.y - 25, 50, 50);
                    
                    // Borde
                    ctx.strokeStyle = '#ecf0f1';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(machine.x - 25, machine.y - 25, 50, 50);
                    
                    // Indicador de entrada
                    if (machine.hasInput) {
                        ctx.fillStyle = '#e74c3c';
                        ctx.beginPath();
                        ctx.arc(machine.x - 15, machine.y - 15, 4, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // Indicador de salida
                    if (machine.hasOutput) {
                        ctx.fillStyle = '#2ecc71';
                        ctx.beginPath();
                        ctx.arc(machine.x + 15, machine.y - 15, 4, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // Progreso
                    if (machine.processing) {
                        ctx.fillStyle = '#27ae60';
                        ctx.fillRect(machine.x - 20, machine.y + 15, (40 * machine.progress) / 100, 5);
                    }
                });
                
                // Recursos
                game.resources.forEach(resource => {
                    ctx.fillStyle = resource.color;
                    ctx.beginPath();
                    ctx.arc(resource.x, resource.y, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Icono
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(resource.icon, resource.x, resource.y + 4);
                });
                
                // Informaci√≥n
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '14px Courier New';
                ctx.textAlign = 'left';
                ctx.fillText(`Puntos: ${game.score}`, 10, 20);
                ctx.fillText(`Tiempo: ${Math.ceil(game.time)}s`, 10, 40);
                ctx.fillText(`Energ√≠a: ${Math.ceil(game.energy)}`, 10, 60);
                
                // Leyenda
                ctx.fillText("R: Recoger recurso", 280, 20);
                ctx.fillText("ESPACIO: Usar m√°quina", 280, 40);
            }
            
            function update() {
                // Mover
                if (GAME.minigames.keys['w'] && game.player.y > 30) game.player.y -= game.player.speed;
                if (GAME.minigames.keys['s'] && game.player.y < 270) game.player.y += game.player.speed;
                if (GAME.minigames.keys['a'] && game.player.x > 20) game.player.x -= game.player.speed;
                if (GAME.minigames.keys['d'] && game.player.x < 380) game.player.x += game.player.speed;
                
                // Recoger recurso (R)
                if (GAME.minigames.keys['r']) {
                    // Crear recurso aleatorio
                    const resources = [
                        {type: 'leche', icon: 'ü•õ', color: '#ffffff'},
                        {type: 'huevo', icon: 'ü•ö', color: '#f1c40f'},
                        {type: 'fruta', icon: 'üçé', color: '#e74c3c'}
                    ];
                    
                    const resource = resources[Math.floor(Math.random() * resources.length)];
                    game.resources.push({
                        x: game.player.x,
                        y: game.player.y,
                        ...resource
                    });
                    
                    GAME.minigames.keys['r'] = false;
                }
                
                // Usar m√°quina (ESPACIO)
                if (GAME.minigames.keys[' ']) {
                    let machineUsed = false;
                    
                    game.machines.forEach(machine => {
                        const dist = Math.sqrt(
                            Math.pow(machine.x - game.player.x, 2) + 
                            Math.pow(machine.y - game.player.y, 2)
                        );
                        
                        if (dist < 40) {
                            // Si no tiene entrada, buscar recurso
                            if (!machine.hasInput && machine.input !== 'none') {
                                let resourceToUse = null;
                                let resourceDist = Infinity;
                                
                                game.resources.forEach(resource => {
                                    const resDist = Math.sqrt(
                                        Math.pow(resource.x - game.player.x, 2) + 
                                        Math.pow(resource.y - game.player.y, 2)
                                    );
                                    
                                    if (resDist < 30 && resource.type === machine.input && resDist < resourceDist) {
                                        resourceDist = resDist;
                                        resourceToUse = resource;
                                    }
                                });
                                
                                if (resourceToUse) {
                                    machine.hasInput = true;
                                    game.resources = game.resources.filter(r => r !== resourceToUse);
                                    game.score += 10;
                                    machineUsed = true;
                                }
                            }
                            
                            // Si tiene entrada y no est√° procesando, comenzar
                            if (machine.hasInput && !machine.processing && !machine.hasOutput && game.energy >= 10) {
                                machine.processing = true;
                                game.energy -= 10;
                                machineUsed = true;
                            }
                            
                            // Si tiene salida, recolectar
                            if (machine.hasOutput) {
                                machine.hasOutput = false;
                                game.score += 30;
                                machineUsed = true;
                            }
                        }
                    });
                    
                    if (machineUsed) {
                        GAME.minigames.keys[' '] = false;
                    }
                }
                
                // Actualizar m√°quinas
                game.machines.forEach(machine => {
                    if (machine.processing) {
                        machine.progress += 1;
                        
                        if (machine.progress >= 100) {
                            machine.processing = false;
                            machine.progress = 0;
                            machine.hasInput = false;
                            machine.hasOutput = true;
                        }
                    }
                });
                
                // Regenerar energ√≠a
                if (game.energy < 100) {
                    game.energy += 0.2;
                }
                
                // Tiempo
                game.time -= 1/60;
                if (game.time <= 0) {
                    endMinigame(game.score);
                }
                
                draw();
            }
            
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            GAME.minigames.interval = setInterval(update, 1000/60);
            updateMinigameStats(game);
        }

        // Minijuego 3: Ganader√≠a (simplificado para mantener el c√≥digo)
        function startAnimalsGame() {
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            
            const game = {
                player: { x: 200, y: 150, size: 20, speed: 4 },
                animals: [],
                score: 0,
                time: 60,
                food: 10
            };
            
            // Configurar UI
            document.getElementById('minigame-title').textContent = "üêî MINIJUEGO DE GANADER√çA";
            document.getElementById('minigame-controls').innerHTML = 
                "CONTROLES: WASD mover, F alimentar, C cepillar, ESPACIO recolectar";
            
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Pasto
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Cercas
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(0, 30, canvas.width, 10);
                ctx.fillRect(0, 260, canvas.width, 10);
                
                // Animales
                game.animals.forEach(animal => {
                    ctx.fillStyle = animal.color;
                    ctx.beginPath();
                    ctx.ellipse(animal.x, animal.y, animal.size, animal.size/1.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Producto si est√° listo
                    if (animal.productReady) {
                        ctx.fillStyle = animal.productColor;
                        ctx.beginPath();
                        ctx.arc(animal.x, animal.y - animal.size, 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
                
                // Jugador
                ctx.fillStyle = '#e67e22';
                ctx.fillRect(game.player.x - game.player.size/2, game.player.y - game.player.size, game.player.size, game.player.size);
                
                // Informaci√≥n
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '14px Courier New';
                ctx.fillText(`Puntos: ${game.score}`, 10, 20);
                ctx.fillText(`Tiempo: ${Math.ceil(game.time)}s`, 10, 40);
                ctx.fillText(`Comida: ${game.food}`, 10, 60);
            }
            
            function update() {
                // Mover
                if (GAME.minigames.keys['w'] && game.player.y > 50) game.player.y -= game.player.speed;
                if (GAME.minigames.keys['s'] && game.player.y < 250) game.player.y += game.player.speed;
                if (GAME.minigames.keys['a'] && game.player.x > 20) game.player.x -= game.player.speed;
                if (GAME.minigames.keys['d'] && game.player.x < 380) game.player.x += game.player.speed;
                
                // Crear animales
                if (Math.random() < 0.01 && game.animals.length < 6) {
                    const types = [
                        {color: '#ecf0f1', productColor: '#ffffff', size: 15},
                        {color: '#f1c40f', productColor: '#f1c40f', size: 12},
                        {color: '#7f8c8d', productColor: '#ffffff', size: 18}
                    ];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    game.animals.push({
                        x: 50 + Math.random() * 300,
                        y: 100 + Math.random() * 120,
                        size: type.size,
                        color: type.color,
                        productColor: type.productColor,
                        productReady: false,
                        happiness: 50,
                        lastAction: Date.now()
                    });
                }
                
                // Acciones
                game.animals.forEach(animal => {
                    // Alimentar (F)
                    if (GAME.minigames.keys['f'] && game.food > 0) {
                        const dist = Math.sqrt(
                            Math.pow(animal.x - game.player.x, 2) + 
                            Math.pow(animal.y - game.player.y, 2)
                        );
                        
                        if (dist < 30 && animal.happiness < 100) {
                            animal.happiness += 20;
                            game.food--;
                            game.score += 5;
                            GAME.minigames.keys['f'] = false;
                        }
                    }
                    
                    // Recolectar (ESPACIO)
                    if (GAME.minigames.keys[' ']) {
                        const dist = Math.sqrt(
                            Math.pow(animal.x - game.player.x, 2) + 
                            Math.pow(animal.y - game.player.y, 2)
                        );
                        
                        if (dist < 30 && animal.productReady) {
                            animal.productReady = false;
                            game.score += 15;
                            GAME.minigames.keys[' '] = false;
                        }
                    }
                    
                    // Producir si est√° feliz
                    if (animal.happiness > 70 && !animal.productReady && Math.random() < 0.01) {
                        animal.productReady = true;
                    }
                    
                    // Disminuir felicidad con el tiempo
                    if (Date.now() - animal.lastAction > 5000) {
                        animal.happiness -= 0.1;
                        animal.lastAction = Date.now();
                    }
                });
                
                // Tiempo
                game.time -= 1/60;
                if (game.time <= 0) {
                    endMinigame(game.score);
                }
                
                draw();
            }
            
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            GAME.minigames.interval = setInterval(update, 1000/60);
            updateMinigameStats(game);
        }

        function updateMinigameStats(game) {
            const statsHTML = `
                <div class="minigame-stat">
                    <div class="minigame-stat-label">PUNTOS</div>
                    <div class="minigame-stat-value">${Math.round(game.score)}</div>
                </div>
                <div class="minigame-stat">
                    <div class="minigame-stat-label">TIEMPO</div>
                    <div class="minigame-stat-value">${Math.ceil(game.time)}s</div>
                </div>
                ${game.stamina !== undefined ? `
                <div class="minigame-stat">
                    <div class="minigame-stat-label">ENERG√çA</div>
                    <div class="minigame-stat-value">${Math.ceil(game.stamina)}</div>
                </div>
                ` : ''}
                ${game.water !== undefined ? `
                <div class="minigame-stat">
                    <div class="minigame-stat-label">AGUA</div>
                    <div class="minigame-stat-value">${Math.ceil(game.water)}</div>
                </div>
                ` : ''}
                ${game.food !== undefined ? `
                <div class="minigame-stat">
                    <div class="minigame-stat-label">COMIDA</div>
                    <div class="minigame-stat-value">${game.food}</div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('minigame-stats').innerHTML = statsHTML;
        }

        function endMinigame(score) {
            if (GAME.minigames.interval) {
                clearInterval(GAME.minigames.interval);
                GAME.minigames.interval = null;
            }
            
            // Convertir puntos del minijuego a puntos principales
            const convertedPoints = Math.floor(score / 2);
            GAME.state.totalPoints += convertedPoints;
            document.getElementById('total-points').textContent = GAME.state.totalPoints;
            
            // Mostrar resultados
            showMessage(`¬°Minijuego completado! Ganaste ${convertedPoints} puntos. Puntos totales: ${GAME.state.totalPoints}`);
            
            // Volver a trivia
            setTimeout(() => {
                backToTrivia();
                document.getElementById('minigame-btn').disabled = false;
            }, 2000);
        }

        // ==================== TIENDA ====================
        function openShop() {
            // Pausar el tiempo
            GAME.state.timePaused = true;
            clearInterval(GAME.state.timer);
            document.getElementById('time-paused').style.display = 'block';
            
            document.getElementById('shop-overlay').style.display = 'flex';
            document.getElementById('shop-balance').textContent = GAME.state.totalPoints;
            updateShopItems();
            
            // Ocultar personaje si est√° visible
            hideCharacter();
        }

        function closeShop() {
            // Reanudar el tiempo
            GAME.state.timePaused = false;
            document.getElementById('time-paused').style.display = 'none';
            
            document.getElementById('shop-overlay').style.display = 'none';
            
            // Si hay pregunta activa, reanudar temporizador
            if (GAME.state.currentQuestion < GAME.levels[GAME.state.currentLevel].questions) {
                startTimer();
            }
        }

        function updateShopItems() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            
            GAME.shopItems.forEach(item => {
                const canAfford = GAME.state.totalPoints >= item.price;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <h3 style="color:#ecf0f1;margin:5px 0;">${item.name}</h3>
                    <p style="color: #bdc3c7; font-size: 0.9rem; margin: 10px 0;">${item.desc}</p>
                    <div class="item-price">${item.price} puntos</div>
                    <button class="btn" onclick="buyItem(${item.id})" 
                            ${!canAfford ? 'disabled' : ''}
                            style="padding: 10px; font-size: 0.9rem; width: 100%; background:${canAfford?'#27ae60':'#7f8c8d'};">
                        ${canAfford ? 'COMPRAR' : 'POCOS PUNTOS'}
                    </button>
                `;
                
                shopItems.appendChild(itemDiv);
            });
        }

        function buyItem(itemId) {
            const item = GAME.shopItems.find(i => i.id === itemId);
            
            if (!item || GAME.state.totalPoints < item.price) {
                showMessage("No tienes suficientes puntos");
                return;
            }
            
            // Restar puntos
            GAME.state.totalPoints -= item.price;
            document.getElementById('total-points').textContent = GAME.state.totalPoints;
            document.getElementById('shop-balance').textContent = GAME.state.totalPoints;
            
            // Aplicar efecto
            switch(item.effect) {
                case 'addHeart':
                    if (GAME.state.hearts < 10) {
                        GAME.state.hearts++;
                        updateHearts();
                        showMessage("‚ù§Ô∏è +1 coraz√≥n extra");
                    }
                    break;
                case 'addTime':
                    GAME.state.timeLeft += 10;
                    updateTimerDisplay();
                    showMessage("‚è∞ +10 segundos en esta pregunta");
                    break;
                case 'addHints':
                    GAME.state.hints += 3;
                    document.getElementById('hint-btn').textContent = `üí° Pista (${GAME.state.hints})`;
                    showMessage("üí° +3 pistas adicionales");
                    break;
                default:
                    showMessage(`¬°${item.name} adquirido!`);
                    break;
            }
            
            showMessage(`¬°${item.name} comprado por ${item.price} puntos!`);
            updateShopItems();
        }

        // ==================== UTILIDADES ====================
        function showMessage(text) {
            const message = document.createElement('div');
            message.className = 'message-toast';
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 3000);
        }

        function gameOver() {
            showMessage(`¬°Juego Terminado! Puntos finales: ${GAME.state.totalPoints}`);
            
            // Deshabilitar botones
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('minigame-btn').disabled = true;
            document.getElementById('hint-btn').disabled = true;
            
            // Mostrar bot√≥n de reinicio
            const gameOverMsg = document.createElement('div');
            gameOverMsg.className = 'message-toast';
            gameOverMsg.style.background = '#e74c3c';
            gameOverMsg.style.borderColor = '#c0392b';
            gameOverMsg.innerHTML = `
                <div style="text-align: center;">
                    <h3 style="margin-bottom:10px;">¬°GAME OVER!</h3>
                    <p style="margin-bottom:10px;">Puntos: ${GAME.state.totalPoints}</p>
                    <button onclick="restartGame()" style="
                        background: white; color: #e74c3c; border: 3px solid #c0392b;
                        padding: 10px 20px; border-radius: 0; margin-top: 10px;
                        font-weight: bold; cursor: pointer; font-family: 'Courier New';
                        box-shadow: 0 4px 0 #c0392b;">
                        üîÑ JUGAR OTRA VEZ
                    </button>
                </div>
            `;
            document.body.appendChild(gameOverMsg);
        }

        function restartGame() {
            // Resetear estado
            GAME.state = {
                totalPoints: 0,
                currentLevel: 0,
                currentQuestion: 0,
                questionsAnswered: 0,
                hearts: 5,
                hints: 3,
                timeLeft: 30,
                timer: null,
                selectedAnswer: null,
                minigameActive: false,
                timePaused: false,
                shopOpen: false,
                characterVisible: false
            };
            
            // Resetear niveles
            GAME.levels.forEach((level, index) => {
                level.completed = index === 0;
                level.unlocked = index === 0;
            });
            
            // Resetear minijuegos
            GAME.minigames = {
                current: null,
                score: 0,
                active: false,
                interval: null,
                keys: {}
            };
            
            // Limpiar mensajes
            document.querySelectorAll('.message-toast').forEach(msg => msg.remove());
            
            // Limpiar canvas
            const canvas = document.getElementById('minigame-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Reiniciar juego
            loadLevel(0);
            startTimer();
            
            // Ocultar personaje
            hideCharacter();
            
            showMessage("¬°Nuevo juego comenzado! Buena suerte.");
        }

        // ==================== INICIAR JUEGO ====================
        window.onload = initGame;
    </script>
</body>
</html>
