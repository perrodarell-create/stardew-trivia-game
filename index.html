<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardew Valley Trivia: Master Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #19232d;
            --panel-bg: #212b36;
            --accent-orange: #f39c12;
            --accent-green: #27ae60;
            --accent-blue: #2980b9;
            --text-light: #ecf0f1;
            --border: #34495e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'VT323', monospace; user-select: none; }

        body {
            background-color: #000;
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; color: var(--text-light);
        }

        /* === PANTALLA DE INICIO === */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
            /* TU FONDO DE PAISAJE */
            background: url('image_754052.jpg') no-repeat center center; 
            background-size: cover;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .logo-box {
            background: rgba(0,0,0,0.7); padding: 20px 40px; border-radius: 20px;
            border: 6px solid var(--accent-orange); margin-bottom: 40px;
            text-align: center;
        }
        .game-title-main {
            font-size: 6rem; color: #ffd700; text-shadow: 5px 5px 0 #8d5524; line-height: 1;
        }
        
        .menu-btn {
            background: var(--accent-orange); border: 4px solid #d35400; color: #fff;
            font-size: 2.5rem; padding: 15px 50px; margin: 15px; cursor: pointer;
            box-shadow: 0 8px 0 #a04000; transition: transform 0.1s;
            animation: pulse 1.5s infinite alternate;
        }
        .menu-btn:hover { filter: brightness(1.2); transform: scale(1.05); }
        .menu-btn:active { transform: translateY(5px); box-shadow: 0 2px 0 #a04000; }
        .menu-btn:disabled { background: #555; border-color: #333; color: #888; animation: none; box-shadow: none; cursor: default; }

        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

        /* === INTERFAZ PRINCIPAL (GRID) === */
        .game-wrapper {
            width: 98vw; height: 97vh;
            background: var(--bg-dark);
            border: 6px solid var(--border);
            border-radius: 10px;
            display: none; /* JS activa esto */
            grid-template-rows: auto auto 1fr;
            gap: 10px; padding: 10px;
            position: relative;
        }

        /* HEADER & TABS */
        .header-area { text-align: center; display: flex; flex-direction: column; gap: 5px; }
        .main-title { font-size: 3rem; color: var(--accent-orange); letter-spacing: 3px; text-shadow: 3px 3px 0 #000; margin: 0; }
        
        .level-tabs { display: flex; justify-content: center; gap: 5px; background: #111; padding: 5px; border-radius: 5px; }
        .tab { 
            padding: 5px 20px; font-size: 1.4rem; color: #777; background: #222; border: 2px solid #444; 
            cursor: default; transition: 0.3s;
        }
        .tab.active { background: var(--accent-orange); color: #fff; border-color: #fff; transform: translateY(-2px); }
        .tab.locked { opacity: 0.5; }

        /* STATS BAR */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .stat-card { 
            background: var(--panel-bg); border: 2px solid var(--border); padding: 5px; text-align: center; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .stat-label { font-size: 0.9rem; color: #aaa; letter-spacing: 1px; }
        .stat-val { font-size: 1.8rem; font-weight: bold; }
        .hearts { color: #e74c3c; } .gold { color: #f1c40f; }

        /* CONTENIDO DIVIDIDO 50/50 */
        .split-view { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; height: 100%; overflow: hidden; }

        /* IZQUIERDA: TRIVIA */
        .left-col { 
            display: flex; flex-direction: column; gap: 10px; 
            background: rgba(255,255,255,0.02); padding: 10px; border-radius: 8px; border: 2px solid var(--border);
        }
        
        .npc-area { display: flex; gap: 10px; height: 120px; align-items: center; }
        .npc-face { 
            width: 100px; height: 100px; background: #333; border: 3px solid #fff; 
            border-radius: 50%; object-fit: cover; image-rendering: pixelated; 
        }
        .npc-bubble { 
            background: #fff; color: #000; padding: 10px; border-radius: 10px; flex-grow: 1; 
            position: relative; font-size: 1.3rem; border: 2px solid #000;
            display: flex; align-items: center;
        }
        .npc-bubble::after { content:''; position: absolute; left:-10px; top:50%; border: 10px solid transparent; border-right-color: #000; transform: translateY(-50%); }

        .shop-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .shop-btn { 
            flex: 1; background: #2c3e50; border: 2px solid #7f8c8d; color: #fff; cursor: pointer; padding: 5px; 
            display: flex; flex-direction: column; align-items: center; font-size: 1rem;
        }
        .shop-btn:hover { background: var(--accent-orange); border-color: #fff; }

        .question-card { 
            flex-grow: 1; background: var(--panel-bg); border: 3px solid var(--accent-green); 
            padding: 15px; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between;
        }
        .q-text { font-size: 1.6rem; color: #fff; margin-bottom: 15px; line-height: 1.2; }
        .options { display: grid; gap: 8px; }
        .opt { 
            background: #34495e; border: 2px solid #2c3e50; padding: 12px; font-size: 1.3rem; color: #ddd; 
            text-align: left; cursor: pointer; transition: 0.2s; 
        }
        .opt:hover { background: #3d566e; border-color: var(--accent-orange); transform: translateX(5px); }
        .opt.selected { background: var(--accent-blue); border-color: #fff; color: #fff; }
        .opt.correct { background: var(--accent-green) !important; border-color: #2ecc71 !important; }
        .opt.incorrect { background: #c0392b !important; border-color: #e74c3c !important; }

        /* DERECHA: MINIJUEGO + INVENTARIO */
        .right-col { display: flex; flex-direction: column; gap: 10px; height: 100%; }

        .minigame-box { 
            flex-grow: 1; border: 4px solid var(--accent-orange); background: #000; position: relative; 
            display: flex; flex-direction: column;
        }
        .minigame-header { 
            background: var(--accent-orange); color: #000; padding: 2px 10px; font-weight: bold; 
            display: flex; justify-content: space-between;
        }
        #canvas { width: 100%; height: 100%; image-rendering: pixelated; background: #222; }
        .controls-hint { 
            position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.6); padding: 5px; font-size: 1rem; color: #fff; pointer-events: none; 
        }

        .inventory-box { height: 140px; background: #111; border: 3px solid #555; padding: 5px; display: flex; flex-direction: column; }
        .inv-title { text-align: center; color: #aaa; margin-bottom: 5px; font-size: 1rem; }
        .inv-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 5px; flex-grow: 1; 
        }
        .slot { 
            background: #2a2a2a; border: 2px solid #444; display: flex; align-items: center; justify-content: center; 
            font-size: 2rem; cursor: pointer; position: relative; transition: 0.1s;
        }
        .slot:hover { border-color: #fff; }
        .slot.active { background: #3d3d3d; border-color: var(--accent-orange); box-shadow: 0 0 10px var(--accent-orange); }
        .key-num { position: absolute; top: 2px; left: 4px; font-size: 0.8rem; color: #888; }
        .slot-name { position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 0.7rem; color: #fff; text-shadow: 1px 1px #000; }

        /* NOTIFICACIONES TOAST */
        #toasts { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 60%; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            background: #fff; border: 4px solid var(--accent-orange); color: #000; padding: 10px 20px; 
            border-radius: 10px; display: flex; align-items: center; gap: 15px; font-size: 1.4rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out; 
        }
        .toast img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #000; object-fit: cover; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* BOT√ìN M√öSICA */
        .music-toggle { position: absolute; top: 20px; right: 20px; background: #fff; color: #000; border: 3px solid #000; padding: 10px; cursor: pointer; font-size: 1.5rem; border-radius: 50%; z-index: 1000; }

    </style>
</head>
<body>

    <button class="music-toggle" onclick="toggleAudio()" id="audio-btn">üîá</button>

    <div id="start-screen">
        <div class="logo-box">
            <h1 class="game-title-main">STARDEW VALLEY<br>TRIVIA</h1>
        </div>
        <button class="menu-btn" onclick="startGame(true)">NUEVA PARTIDA</button>
        <button class="menu-btn" id="btn-continue" onclick="startGame(false)" disabled>CONTINUAR</button>
    </div>

    <div id="toasts"></div>

    <div class="game-wrapper" id="game-ui">
        <div class="header-area">
            <h2 class="main-title">STARDEW VALLEY TRIVIA</h2>
            <div class="level-tabs">
                <div class="tab" id="tab-0">Agricultura</div>
                <div class="tab" id="tab-1">Pesca</div>
                <div class="tab" id="tab-2">Ganader√≠a</div>
                <div class="tab" id="tab-3">Miner√≠a</div>
                <div class="tab" id="tab-4">Tecnolog√≠a</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><span class="stat-label">PUNTOS</span><span class="stat-val" id="ui-score">0</span></div>
            <div class="stat-card"><span class="stat-label">NIVEL</span><span class="stat-val" id="ui-level">1</span></div>
            <div class="stat-card"><span class="stat-label">PREGUNTA</span><span class="stat-val"><span id="ui-q">1</span>/20</span></div>
            <div class="stat-card"><span class="stat-label">TIEMPO</span><span class="stat-val" id="ui-time">60s</span></div>
            <div class="stat-card"><span class="stat-label">SALUD</span><span class="stat-val hearts" id="ui-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
        </div>

        <div class="split-view">
            <div class="left-col">
                <div class="npc-area">
                    <img src="" id="npc-img" class="npc-face">
                    <div class="npc-bubble" id="npc-text">...</div>
                </div>
                
                <div class="shop-row">
                    <button class="shop-btn" onclick="buy('heart')"><span>‚ù§Ô∏è Vida</span><small>200g</small></button>
                    <button class="shop-btn" onclick="buy('time')"><span>‚è≥ Tiempo</span><small>100g</small></button>
                    <button class="shop-btn" onclick="buy('hint')"><span>üí° Pista</span><small>50g</small></button>
                </div>

                <div class="question-card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#aaa;">
                        <span id="season-tag">Primavera</span>
                        <span class="gold">ü™ô <span id="ui-gold">0</span>g</span>
                    </div>
                    <div class="q-text" id="q-text">...</div>
                    <div class="options" id="q-options"></div>
                    <button class="menu-btn" style="font-size:1.5rem; padding:10px; margin:10px 0 0 0; background:var(--accent-green); border-color:#1e8449;" id="btn-confirm" onclick="checkAnswer()">CONFIRMAR</button>
                </div>
            </div>

            <div class="right-col">
                <div class="minigame-box">
                    <div class="minigame-header">
                        <span>MINIJUEGO</span>
                        <span id="net-counter" style="display:none">Red: 0/10 üêü</span>
                    </div>
                    <canvas id="canvas" width="600" height="400"></canvas>
                    <div class="controls-hint" id="controls-hint">WASD: Mover | ESPACIO: Acci√≥n</div>
                </div>

                <div class="inventory-box">
                    <div class="inv-title">MOCHILA (Teclas 1-6)</div>
                    <div class="inv-grid" id="inventory"></div>
                </div>
            </div>
        </div>
    </div>

<script>
// ==================== CONFIGURACI√ìN ====================
// IM√ÅGENES (Usando tus nombres de archivo)
const IMG = {
    haley: "image_74cfd5.png", 
    haley_h: "image_74cff3.jpg",
    abigail: "image_74cd0b.png", 
    abigail_h: "image_74cfb5.jpg",
    bg: "image_754052.jpg"
};

// ==================== BASE DE DATOS (100 PREGUNTAS) ====================
const DB = {
    // NIVEL 1: AGRICULTURA (5 por estaci√≥n)
    0: {
        "Primavera": [
            {q: "¬øQu√© hortaliza roja es t√≠pica de la primavera?", a:["Fresa","Sand√≠a","Calabaza","Trigo"], c:0},
            {q: "¬øQu√© herramienta voltea la tierra?", a:["Azada","Pico","Hacha","Guada√±a"], c:0},
            {q: "¬øQu√© flor sigue al sol?", a:["Girasol","Rosa","Tulip√°n","Orqu√≠dea"], c:0},
            {q: "¬øQu√© necesitan las semillas para nacer?", a:["Agua y Calor","Oscuridad","Fr√≠o","Viento"], c:0},
            {q: "¬øQu√© legumbre fija nitr√≥geno?", a:["Frijol","Ma√≠z","Tomate","Lechuga"], c:0}
        ],
        "Verano": [
            {q: "¬øQu√© baya azul crece en arbustos en verano?", a:["Ar√°ndano","Fresa","Mora","Cereza"], c:0},
            {q: "¬øQu√© cultivo necesita mucha agua y sol?", a:["Mel√≥n","Ajo","Espinaca","Col"], c:0},
            {q: "¬øQu√© insecto poliniza m√°s?", a:["Abeja","Hormiga","Mosca","Grillo"], c:0},
            {q: "¬øQu√© cereal crece en mazorcas?", a:["Ma√≠z","Trigo","Arroz","Avena"], c:0},
            {q: "¬øQu√© sistema de riego es m√°s eficiente?", a:["Goteo","Inundaci√≥n","Manguera","Aspersor"], c:0}
        ],
        "Oto√±o": [
            {q: "¬øQu√© hortaliza naranja se usa en Halloween?", a:["Calabaza","Zanahoria","Naranja","Melocot√≥n"], c:0},
            {q: "¬øQu√© fruto seco cae de los robles?", a:["Bellota","Nuez","Almendra","Pistacho"], c:0},
            {q: "¬øQu√© flor morada florece en oto√±o?", a:["Amaranto","Rosa","Girasol","Tulip√°n"], c:0},
            {q: "¬øQu√© hongo es comestible?", a:["Champi√±√≥n","Amanita","Moho","Hongo Rojo"], c:0},
            {q: "¬øQu√© herramienta junta hojas secas?", a:["Rastrillo","Pala","Pico","Azada"], c:0}
        ],
        "Invierno": [
            {q: "¬øQu√© estructura protege del fr√≠o?", a:["Invernadero","Silo","Establo","Pozo"], c:0},
            {q: "¬øQu√© hacen los √°rboles en invierno?", a:["Dormancia","Crecer","Florecer","Morir"], c:0},
            {q: "¬øQu√© ra√≠z resiste el fr√≠o?", a:["Zanahoria","Tomate","Sand√≠a","Pimiento"], c:0},
            {q: "¬øQu√© cristaliza el agua en las plantas?", a:["Helada","Roc√≠o","Niebla","Lluvia"], c:0},
            {q: "¬øQu√© actividad agr√≠cola se hace en invierno?", a:["Poda","Siembra","Cosecha","Riego"], c:0}
        ]
    },
    // NIVEL 2: PESCA (20 Preguntas)
    1: [
        {q:"¬øAgua de mar?", a:["Salada","Dulce","Destilada","Gas"], c:0},
        {q:"¬øPez que remonta r√≠os?", a:["Salm√≥n","At√∫n","Sardina","Carpa"], c:0},
        {q:"¬ø√ìrgano para respirar bajo agua?", a:["Branquias","Pulmones","Nariz","Piel"], c:0},
        {q:"¬øCr√≠a de peces controlada?", a:["Acuicultura","Pesca","Caza","Ganader√≠a"], c:0},
        {q:"¬øPez plano del fondo?", a:["Lenguado","Trucha","Dorado","Pez Espada"], c:0},
        {q:"¬øCebo artificial?", a:["Se√±uelo","Gusano","Pan","Ma√≠z"], c:0},
        {q:"¬øPez gigante de r√≠o?", a:["Esturi√≥n","Sardina","Anchoa","Payaso"], c:0},
        {q:"¬øQu√© atrae a los peces?", a:["Movimiento/Olor","Ruido","Luz fuerte","Gritos"], c:0},
        {q:"¬øPez famoso por ser venenoso?", a:["Pez Globo","Salm√≥n","Tilapia","Merluza"], c:0},
        {q:"¬øCrust√°ceo con pinzas?", a:["Cangrejo","Pulpo","Medusa","Estrella"], c:0},
        // Relleno hasta 20...
    ].concat(Array(10).fill({q:"¬øPregunta de Pesca Extra?", a:["Opci√≥n A","Opci√≥n B","Opci√≥n C","Opci√≥n D"], c:0})),
    
    // NIVEL 3: GANADER√çA
    2: Array(20).fill({q:"¬øQu√© come la vaca?", a:["Pasto","Carne","Piedras","Pl√°stico"], c:0}),
    // NIVEL 4: MINER√çA
    3: Array(20).fill({q:"¬øMineral m√°s duro?", a:["Diamante","Talco","Hierro","Oro"], c:0}),
    // NIVEL 5: TECNOLOG√çA
    4: Array(20).fill({q:"¬øRiego autom√°tico?", a:["Aspersor","Manguera","Cubo","Nubes"], c:0})
};

// HERRAMIENTAS
const TOOLS = {
    farm: [
        {n:"Azada",i:"‚õèÔ∏è"}, {n:"Regadera",i:"üíß"}, {n:"Fresa",i:"üçì"}, 
        {n:"Ar√°ndano",i:"ü´ê"}, {n:"Calabaza",i:"üéÉ"}, {n:"Cosechar",i:"‚úÇÔ∏è"}
    ],
    fish: [{n:"Ca√±a",i:"üé£"}],
    ranch: [{n:"Heno",i:"üåæ"}, {n:"Acariciar",i:"üñêÔ∏è"}],
    mine: [{n:"Pico",i:"üî®"}],
    tech: [{n:"Fertilizante",i:"üß™"}, {n:"Riego",i:"üöø"}]
};

// ==================== ESTADO Y LOGICA ====================
const STATE = {
    level: 0, seasonIdx: 0, qIndex: 0, qTotal: 0,
    hearts: 5, gold: 0, score: 0, time: 60,
    inventory: [], toolIdx: 0, selOpt: -1,
    loop: null,
    // Minijuego
    farm: [], fish: {y:200, t:200, bY:200, bV:0, p:30, catch:0},
    entities: [],
    player: {x:300, y:200, w:30, h:30}
};

// AUDIO
const audio = new Audio("https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3");
audio.loop = true; audio.volume = 0.3;
let musicOn = false;

function toggleAudio() {
    musicOn = !musicOn;
    musicOn ? audio.play() : audio.pause();
    document.getElementById('audio-btn').innerText = musicOn ? "üîä" : "üîá";
}

// INICIO
const save = localStorage.getItem('sv_master_save');
if(save) document.getElementById('btn-continue').disabled = false;

function startGame(isNew) {
    document.getElementById('start-screen').style.display = 'none';
    document.querySelector('.game-wrapper').style.display = 'grid';
    if(isNew || !save) {
        STATE.level=0; STATE.gold=50; STATE.hearts=5; STATE.seasonIdx=0; STATE.qIndex=0;
        toast("¬°Bienvenido a la granja!", IMG.haley);
    } else {
        Object.assign(STATE, JSON.parse(save));
        toast("¬°Regresaste!", IMG.haley);
    }
    toggleAudio(); // Iniciar musica tras click
    initLevel();
    gameLoop();
}

function initLevel() {
    // Config UI Nivel
    document.querySelectorAll('.tab').forEach((t,i) => t.className = `tab ${i===STATE.level?'active':''}`);
    document.getElementById('ui-level').innerText = STATE.level + 1;
    
    // Config Minijuego
    if(STATE.level === 0) { // Granja
        if(STATE.farm.length === 0) { // Iniciar grid si est√° vacio
            for(let r=0; r<6; r++) for(let c=0; c<8; c++) 
                STATE.farm.push({x:c*50+50, y:r*50+50, t:'grass', w:false, c:-1, age:0});
        }
    } else if (STATE.level === 1) { // Pesca
        document.getElementById('net-counter').style.display = 'block';
    } else if (STATE.level === 2 || STATE.level === 3) { // Ganaderia/Mineria
        STATE.entities = [];
        for(let i=0; i<6; i++) STATE.entities.push({
            x:Math.random()*500, y:Math.random()*500, 
            type: STATE.level===2 ? (Math.random()>.5?'cow':'pig') : 'rock', 
            hp:3, fed:false
        });
    }

    renderInventory();
    loadQuestion();
    updateUI();
}

function renderInventory() {
    const list = TOOLS[Object.keys(TOOLS)[STATE.level]];
    const grid = document.getElementById('inventory');
    grid.innerHTML = '';
    list.forEach((t, i) => {
        const d = document.createElement('div');
        d.className = `slot ${i===STATE.toolIdx?'active':''}`;
        d.innerHTML = `<span class="key-num">${i+1}</span>${t.i}<span class="slot-name">${t.n}</span>`;
        d.onclick = () => { STATE.toolIdx=i; renderInventory(); };
        grid.appendChild(d);
    });
}

// PREGUNTAS
function loadQuestion() {
    // Mec√°nica Riego (Nivel 1)
    if(STATE.level === 0 && STATE.qTotal > 0 && STATE.qTotal % 4 === 0) {
        STATE.farm.forEach(t => t.w = false); // Secar
        toast("¬°La tierra se sec√≥! Riega.", IMG.haley);
    }

    let qData;
    if(STATE.level === 0) {
        const seasons = ["Primavera", "Verano", "Oto√±o", "Invierno"];
        if(STATE.qIndex >= 5) { STATE.seasonIdx++; STATE.qIndex=0; }
        if(STATE.seasonIdx > 3) { nextLevel(); return; }
        document.getElementById('season-tag').innerText = seasons[STATE.seasonIdx];
        qData = DB[0][seasons[STATE.seasonIdx]][STATE.qIndex];
    } else {
        if(STATE.qIndex >= 20) { nextLevel(); return; }
        qData = DB[STATE.level][STATE.qIndex];
    }

    document.getElementById('q-text').innerText = qData.q;
    document.getElementById('ui-q').innerText = (STATE.seasonIdx*5 + STATE.qIndex + 1);
    
    const div = document.getElementById('q-options');
    div.innerHTML = '';
    STATE.selOpt = -1;
    document.getElementById('btn-confirm').disabled = true;

    // Shuffle options
    let opts = qData.a.map((txt, i) => ({txt, i}));
    opts.sort(()=>Math.random()-0.5);

    opts.forEach(o => {
        const btn = document.createElement('button');
        btn.className = 'opt';
        btn.innerText = o.txt;
        btn.onclick = () => {
            document.querySelectorAll('.opt').forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            STATE.selOpt = o.i;
            document.getElementById('btn-confirm').disabled = false;
        };
        div.appendChild(btn);
    });
    
    setNPC("¬°T√∫ puedes!");
}

function checkAnswer() {
    let correct;
    if(STATE.level===0) {
        const seasons = ["Primavera", "Verano", "Oto√±o", "Invierno"];
        correct = DB[0][seasons[STATE.seasonIdx]][STATE.qIndex].c;
    } else {
        correct = DB[STATE.level][STATE.qIndex].c;
    }

    if(STATE.selOpt === correct) {
        STATE.score += 100; STATE.gold += 50; STATE.qTotal++;
        toast("¬°Correcto! +50g", IMG.haley_h);
        // Bonus granja
        if(STATE.level===0) STATE.farm.forEach(t=>{if(t.c>-1 && t.w) t.age++});
    } else {
        STATE.hearts--;
        toast("Incorrecto...", IMG.haley);
    }
    
    updateUI();
    STATE.qIndex++;
    saveProgress();
    
    if(STATE.hearts<=0) { alert("GAME OVER"); location.reload(); }
    else loadQuestion();
}

function nextLevel() {
    if(STATE.level < 4) {
        STATE.level++; STATE.qIndex=0; STATE.seasonIdx=0;
        alert("¬°NIVEL COMPLETADO!");
        initLevel();
    } else {
        alert("¬°JUEGO COMPLETADO! ERES UN MAESTRO.");
    }
}

// MINIJUEGOS LOOP
const cvs = document.getElementById('canvas');
const ctx = cvs.getContext('2d');

function gameLoop() {
    updateGame();
    drawGame();
    requestAnimationFrame(gameLoop);
}

// INPUT
const keys = {};
window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if(e.key >= '1' && e.key <= '6') { STATE.toolIdx = parseInt(e.key)-1; renderInventory(); }
    if(e.key === ' ') e.preventDefault();
});
window.addEventListener('keyup', e => {
    keys[e.key.toLowerCase()] = false;
    if(e.key === ' ') handleAction(); // Acci√≥n al soltar o presionar (mejor soltar para no spam)
});

function updateGame() {
    // Mover jugador (WASD)
    if(STATE.level !== 1) { // En pesca no se mueve
        if(keys['w']) STATE.player.y -= 3;
        if(keys['s']) STATE.player.y += 3;
        if(keys['a']) STATE.player.x -= 3;
        if(keys['d']) STATE.player.x += 3;
    }

    // Pesca F√≠sica
    if(STATE.level === 1) {
        if(keys[' ']) STATE.fish.bV -= 0.5;
        STATE.fish.bV += 0.2; // Gravedad
        STATE.fish.bY += STATE.fish.bV;
        // Limites
        if(STATE.fish.bY < 0) STATE.fish.bY=0; 
        if(STATE.fish.bY > 300) STATE.fish.bY=300;
        
        // Pez IA
        if(Math.random()<0.05) STATE.fish.t = Math.random()*300;
        STATE.fish.y += (STATE.fish.t - STATE.fish.y)*0.05;

        // Captura
        if(STATE.fish.y > STATE.fish.bY && STATE.fish.y < STATE.fish.bY+80) STATE.fish.p += 0.5;
        else STATE.fish.p -= 0.3;
        
        if(STATE.fish.p < 0) STATE.fish.p = 0;
        if(STATE.fish.p > 100) {
            STATE.fish.p = 20; STATE.fish.catch++; STATE.gold+=20;
            document.getElementById('net-counter').innerText = `Red: ${STATE.fish.catch}/10 üêü`;
            toast("¬°Pescado! +20g", IMG.abigail_h);
            updateUI();
        }
    }
}

function handleAction() {
    const p = STATE.player;
    if(STATE.level === 0) { // Granja
        let t = STATE.farm.find(tile => Math.hypot(tile.x-p.x, tile.y-p.y) < 40);
        if(t) {
            // 0:Azada, 1:Regadera, 2:Fresa, 3:Arandano, 4:Calabaza, 5:Cosechar
            if(STATE.toolIdx===0 && t.t==='grass') t.t='dirt';
            if(STATE.toolIdx===1 && t.t==='dirt') t.w=true;
            if(STATE.toolIdx>=2 && STATE.toolIdx<=4 && t.t==='dirt' && t.c===-1) {
                t.c = STATE.toolIdx; t.age=1; // Plantar
            }
            if(STATE.toolIdx===5 && t.age>=4) {
                t.c=-1; t.t='dirt'; t.w=false; STATE.gold+=30; toast("Cosechado +30g", IMG.haley_h); updateUI();
            }
        }
    }
    if(STATE.level === 2 || STATE.level === 3) { // Ganaderia/Mineria
        let e = STATE.entities.find(en => Math.hypot(en.x-p.x, en.y-p.y) < 50);
        if(e) {
            if(STATE.level===2 && STATE.toolIdx===0 && !e.fed) { e.fed=true; STATE.gold+=10; toast("Alimentado", IMG.haley); }
            if(STATE.level===3 && STATE.toolIdx===0) { 
                e.hp--; 
                if(e.hp<=0) { 
                    STATE.entities = STATE.entities.filter(x=>x!==e); 
                    STATE.gold+=50; toast("Mineral +50g", IMG.abigail); 
                }
            }
            updateUI();
        }
    }
}

function drawGame() {
    ctx.clearRect(0,0,600,400);
    
    if(STATE.level === 0) { // Granja Draw
        STATE.farm.forEach(t => {
            ctx.fillStyle = t.t==='grass' ? '#56bc4b' : '#8d6e63';
            ctx.fillRect(t.x, t.y, 40, 40);
            if(t.w) { ctx.fillStyle='rgba(0,0,255,0.3)'; ctx.fillRect(t.x,t.y,40,40); }
            if(t.c !== -1) {
                // Color segun cultivo (2:Roja, 3:Azul, 4:Naranja)
                ctx.fillStyle = t.c===2?'#e74c3c': t.c===3?'#3498db':'#e67e22';
                let s = t.age * 8; 
                ctx.fillRect(t.x+20-s/2, t.y+20-s/2, s, s);
            }
        });
    } 
    else if (STATE.level === 1) { // Pesca Draw
        ctx.fillStyle = "#2980b9"; ctx.fillRect(0,0,600,400);
        // Barra
        ctx.fillStyle = "#2c3e50"; ctx.fillRect(200, 20, 50, 360);
        ctx.fillStyle = "#27ae60"; ctx.fillRect(205, 20+STATE.fish.bY, 40, 80);
        // Pez
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(215, 20+STATE.fish.y, 20, 20);
        // Progreso
        ctx.fillStyle = "#222"; ctx.fillRect(260, 20, 20, 360);
        ctx.fillStyle = "#f39c12"; ctx.fillRect(260, 380-(STATE.fish.p*3.6), 20, STATE.fish.p*3.6);
    }
    else { // Otros
        ctx.fillStyle = STATE.level===3 ? "#3e2723" : "#76c747";
        ctx.fillRect(0,0,600,400);
        STATE.entities.forEach(e => {
            ctx.fillStyle = e.type==='rock'?'#7f8c8d' : '#fff';
            ctx.fillRect(e.x, e.y, 40, 40);
            if(e.fed) ctx.fillText("‚ù§Ô∏è", e.x, e.y);
        });
    }

    if(STATE.level !== 1) {
        ctx.fillStyle = "#fff";
        ctx.fillRect(STATE.player.x, STATE.player.y, 30, 30); // Jugador
    }
}

// UTILIDADES
function updateUI() {
    document.getElementById('ui-score').innerText = STATE.score;
    document.getElementById('ui-level').innerText = STATE.level+1;
    document.getElementById('ui-gold').innerText = STATE.gold;
    document.getElementById('ui-hearts').innerText = "‚ù§Ô∏è".repeat(STATE.hearts);
}
function setNPC(msg) { document.getElementById('npc-text').innerText = msg; document.getElementById('npc-img').src = IMG.haley; }
function toast(msg, img) {
    const t = document.createElement('div'); t.className = 'toast';
    t.innerHTML = `<img src="${img || IMG.haley}"><span>${msg}</span>`;
    document.getElementById('toasts').appendChild(t);
    setTimeout(() => t.remove(), 3000);
}
function buy(item) {
    let cost = item==='heart'?200 : item==='time'?100 : 50;
    if(STATE.gold >= cost) {
        STATE.gold -= cost;
        if(item==='heart') STATE.hearts++;
        if(item==='time') STATE.time+=30;
        if(item==='hint') toast("Pista: Piensa con l√≥gica.", IMG.abigail);
        toast("¬°Comprado!", IMG.haley_h);
        updateUI();
    } else toast("Falta Oro", IMG.haley);
}
function saveProgress() { localStorage.setItem('sv_master_save', JSON.stringify(STATE)); }

// Timer Global
setInterval(() => {
    if(document.getElementById('start-screen').style.display==='none') {
        STATE.time--;
        document.getElementById('ui-time').innerText = STATE.time + 's';
        if(STATE.time<=0) { STATE.hearts--; STATE.time=60; toast("¬°Tiempo fuera!", IMG.abigail); updateUI(); }
        if(STATE.hearts<=0) location.reload();
    }
}, 1000);

</script>
</body>
</html>
